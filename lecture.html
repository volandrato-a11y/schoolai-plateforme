<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="layout.js"></script>
    <style>#viewer { height: 75vh; background: #fff; } .arrow-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 50; background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }</style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden">

    <nav class="bg-white shadow-sm px-4 py-2 flex justify-between items-center z-50 shrink-0 h-14 border-b">
        <div class="flex items-center gap-3 overflow-hidden">
            <a href="biblio.html" class="text-gray-500 hover:text-blue-600 px-2"><i class="fas fa-arrow-left"></i></a>
            <h1 id="book-title" class="font-bold text-slate-800 truncate text-sm">Chargement...</h1>
        </div>
        <div id="reader-controls" class="flex items-center gap-2">
            <button onclick="changeFontSize(-2)" class="p-2 text-gray-500"><i class="fas fa-minus"></i></button>
            <span class="text-xs font-bold text-gray-400">Aa</span>
            <button onclick="changeFontSize(2)" class="p-2 text-gray-500"><i class="fas fa-plus"></i></button>
        </div>
    </nav>

    <div class="flex-1 relative w-full max-w-4xl mx-auto bg-white shadow-xl my-0 md:my-4 md:rounded-xl overflow-hidden">
        
        <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-sm font-bold text-gray-500">Ouverture du livre...</p>
        </div>

        <div id="paywall" class="hidden absolute inset-0 z-40 bg-white flex flex-col items-center justify-center p-6 text-center">
            <i class="fas fa-lock text-4xl text-blue-300 mb-4"></i>
            <h2 class="text-xl font-bold">Contenu Payant</h2>
            <p class="text-sm text-gray-500 mb-4">500 Ar pour débloquer</p>
            <button class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold">Débloquer</button>
        </div>

        <div id="reader-container" class="w-full h-full relative hidden">
            <button class="arrow-btn left-2" onclick="rendition.prev()"><i class="fas fa-chevron-left"></i></button>
            <div id="viewer" class="w-full h-full"></div>
            <button class="arrow-btn right-2" onclick="rendition.next()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div id="layout-footer"></div> <script type="module">
        import { createClient } from "https://esm.run/@supabase/supabase-js";
        const SUPABASE_URL = "https://jdxdthxztokjhprwynyf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGR0aHh6dG9ramhwcnd5bnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODAyNzgsImV4cCI6MjA4Mjc1NjI3OH0.zal-p0RKJ-PYGvzal1K9-asbUbyQmqG5OtPTWnoHQmI";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        window.rendition = null;
        window.onload = async function() {
            const id = new URLSearchParams(window.location.search).get('id');
            if(!id) window.location.href='biblio.html';
            const { data } = await supabase.from('lessons').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('book-title').innerText = data.titre;
                // SIMULATION LECTURE DIRECTE (Remettre logique paywall ici)
                openReader(data.file_url);
            }
        };
        async function openReader(url) {
            try {
                const response = await fetch(url);
                const buffer = await response.arrayBuffer();
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('reader-container').classList.remove('hidden');
                const book = ePub(buffer);
                window.rendition = book.renderTo("viewer", { width: "100%", height: "100%", flow: "paginated" });
                window.rendition.display();
            } catch(e) { alert("Erreur chargement livre"); }
        }
        window.changeFontSize = function(v) { if(window.rendition) window.rendition.themes.fontSize((100+v*10)+"%"); }
    </script>
</body>
</html>
