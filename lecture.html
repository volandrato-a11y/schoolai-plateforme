<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lecture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        #actions { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        #viewer { height: 600px; border: 1px solid #ddd; display: none; }
        .btn { padding: 10px 20px; color: white; border: none; cursor: pointer; text-decoration: none; margin-right: 10px; }
        .btn-pay { background: #e74c3c; }
        .btn-read { background: #3498db; }
        .btn-down { background: #27ae60; }
        
        /* Modal Paiement */
        #modal { display: none; position: fixed; top:20%; left:30%; width:400px; background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.5); border-radius:8px; }
    </style>
</head>
<body>

    <div id="infos-livre">Chargement...</div>

    <div id="actions">
        </div>

    <div id="viewer"></div>

    <div id="modal">
        <h3>Paiement requis</h3>
        <p>Payer au <strong>034 91 207 26 (Ndrato)</strong></p>
        <form id="form-pay">
            <input type="text" id="nom" placeholder="Nom" required style="width:90%; margin:5px 0;"><br>
            <input type="text" id="num" placeholder="Num√©ro" required style="width:90%; margin:5px 0;"><br>
            <input type="text" id="tid" placeholder="Transaction ID" required style="width:90%; margin:5px 0;"><br>
            <button type="submit" class="btn btn-pay">Envoyer</button>
            <button type="button" onclick="document.getElementById('modal').style.display='none'">Annuler</button>
        </form>
    </div>

    <script type="module">
        import { supabase } from './supabase-config.js';

        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');
        const userId = "user_demo_1"; // ‚ö†Ô∏è Remplace par un vrai syst√®me de login si possible

        let bookData = null;

        // 1. Charger Livre
        async function init() {
            const { data: livre } = await supabase.from('livres').select('*').eq('id', bookId).single();
            if(!livre) return document.body.innerHTML = "Livre introuvable";
            
            bookData = livre;
            document.getElementById('infos-livre').innerHTML = `
                <h1>${livre.titre}</h1>
                <p>${livre.resume}</p>
                <img src="${livre.cover_url}" style="width:100px;">
            `;

            verifierAchat();
        }

        // 2. V√©rifier Achat & √âcouteur Temps R√©el
        async function verifierAchat() {
            // Chercher une transaction existante
            const { data: transac } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', userId)
                .eq('book_id', bookId)
                .single(); // Peut √™tre null si pas encore achet√©

            majInterface(transac);

            // √âcouter les changements UNIQUEMENT pour cet utilisateur et ce livre
            supabase.channel('custom-filter-channel')
                .on(
                    'postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'transactions', filter: `user_id=eq.${userId}` }, 
                    (payload) => {
                        // Si l'update concerne ce livre, on met √† jour
                        if(payload.new.book_id == bookId) {
                            majInterface(payload.new);
                        }
                    }
                )
                .subscribe();
        }

        function majInterface(transac) {
            const div = document.getElementById('actions');
            
            // Cas 1: Pas de transaction => Bouton Payer
            if (!transac) {
                div.innerHTML = `<button class="btn btn-pay" onclick="document.getElementById('modal').style.display='block'">D√©bloquer (Payer)</button>`;
            } 
            // Cas 2: En attente
            else if (transac.status === 'en_attente') {
                div.innerHTML = `<p style="color:orange;">‚è≥ Paiement en cours de validation...</p>`;
            } 
            // Cas 3: Valid√©
            else if (transac.status === 'valide') {
                div.innerHTML = `
                    <button class="btn btn-read" onclick="lire()">üìñ Lire</button>
                    <a href="${bookData.epub_url}" class="btn btn-down" download>üì• T√©l√©charger</a>
                `;
            }
        }

        // 3. Envoyer Paiement
        document.getElementById('form-pay').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const { error } = await supabase.from('transactions').insert({
                user_id: userId,
                book_id: bookId,
                nom_payeur: document.getElementById('nom').value,
                numero_payeur: document.getElementById('num').value,
                transac_id: document.getElementById('tid').value,
                status: 'en_attente'
            });

            if(!error) {
                document.getElementById('modal').style.display = 'none';
                alert("Envoy√© !");
                // On recharge manuellement l'√©tat pour afficher "en attente" tout de suite
                verifierAchat();
            }
        });

        // 4. Lecteur
        window.lire = function() {
            if(!bookData.epub_url) return alert("Pas d'URL");
            document.getElementById('viewer').style.display = 'block';
            document.getElementById('viewer').innerHTML = "";
            
            const book = ePub(bookData.epub_url);
            const rendition = book.renderTo("viewer", { width: "100%", height: "100%", flow: "scrolled-doc" });
            rendition.display();
        }

        init();
    </script>
</body>
</html>
