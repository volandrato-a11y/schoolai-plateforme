<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Studio SchoolAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-source { border-color: #3b82f6 !important; background-color: #eff6ff !important; color: #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 hidden" id="body-content">

    <div class="max-w-6xl mx-auto py-8 px-4">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-black text-blue-900"><i class="fas fa-magic text-blue-600 mr-3"></i>Studio SchoolAI</h1>
            <div class="flex gap-4 items-center mt-4 md:mt-0">
                <a href="index.html" class="text-gray-500 hover:text-blue-600 font-bold text-sm flex items-center">Voir le site <i class="fas fa-external-link-alt ml-2"></i></a>
                <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-100 transition border border-red-200"><i class="fas fa-sign-out-alt mr-2"></i>D√©connexion</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <button onclick="switchTab('create')" id="tab-create" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white"><i class="fas fa-plus-circle mr-2"></i>Cr√©er / Modifier</button>
            <button onclick="switchTab('manage')" id="tab-manage" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-tasks mr-2"></i>Contenu</button>
            <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-money-bill-wave mr-2"></i>Ventes</button>
            <button onclick="switchTab('ads')" id="tab-ads" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-ad mr-2"></i>Pubs</button>
        </div>

        <div id="view-create" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-4">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">1. Classement</h2>
                    <input type="hidden" id="edit-mode-id" value="">
                    
                    <div class="space-y-4">
                        <select id="select-niveau" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadClasses()"><option value="">Chargement...</option></select>
                        <select id="select-classe" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadMatieres()"><option value="">-- D'abord le niveau --</option></select>
                        <select id="select-matiere" class="w-full p-3 border rounded-xl bg-gray-50"><option value="">-- D'abord la classe --</option></select>
                    </div>

                    <div id="library-options" class="hidden mt-6 pt-6 border-t border-gray-100 animate-fade-in bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h3 class="font-bold text-sm text-purple-700 mb-3"><i class="fas fa-book mr-2"></i>Info Biblioth√®que</h3>
                        <div class="space-y-3">
                            <input type="text" id="meta-auteur" placeholder="Auteur" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <input type="text" id="meta-cover" placeholder="URL Image Couverture (https://...)" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <select id="meta-genre" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white font-bold text-gray-600">
                                <option value="">-- Cat√©gorie --</option>
                                <option value="Roman">üìñ Roman</option><option value="Manuel">üìò Manuel</option><option value="Cours">üéì Cours</option><option value="Jeunesse">üß∏ Jeunesse</option><option value="BD">üí≠ BD/Manga</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="check-publie" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                            <span class="text-slate-700 font-bold text-sm">Publier imm√©diatement ?</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1 ml-8">D√©coch√© = Brouillon (Invisible √©l√®ves)</p>
                    </div>

                    <div class="relative py-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div><div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400 font-bold">Ou cr√©er nouveau</span></div></div>
                    <button onclick="toggleNewForm()" class="w-full py-3 text-sm text-blue-600 font-bold border border-blue-100 bg-blue-50 rounded-xl hover:bg-blue-100 transition"><i class="fas fa-plus-circle mr-2"></i>Nouvelle Mati√®re</button>
                    <div id="new-form" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <select id="new-niveau" class="w-full mb-3 p-2 text-sm border rounded-lg font-bold text-blue-900"><option value="Primaire">Primaire</option><option value="Coll√®ge">Coll√®ge</option><option value="Lyc√©e">Lyc√©e</option><option value="Formation Pro">Formation Pro</option></select>
                        <input id="new-classe" type="text" placeholder="Classe" class="w-full mb-3 p-2 text-sm border rounded-lg">
                        <input id="new-matiere" type="text" placeholder="Mati√®re" class="w-full p-2 text-sm border rounded-lg">
                    </div>
                    
                    <button id="btn-cancel-edit-mode" onclick="cancelEditMode()" class="hidden w-full mt-4 py-3 text-gray-600 font-bold border border-gray-300 bg-gray-100 rounded-xl hover:bg-gray-200 transition"><i class="fas fa-times mr-2"></i> Annuler modif</button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-blue-600 relative">
                    <h2 class="font-bold text-xl mb-6 text-slate-800 border-b pb-2" id="form-title">2. Contenu du Cours</h2>
                    
                    <div class="flex gap-4 mb-6">
                        <button onclick="toggleSource('file')" id="btn-source-file" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition">
                            <i class="fas fa-file-upload mr-2"></i> Fichier (PDF/EPUB)
                        </button>
                        <button onclick="toggleSource('manual')" id="btn-source-manual" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition">
                            <i class="fas fa-keyboard mr-2"></i> √âditeur Manuel
                        </button>
                    </div>

                    <div id="zone-upload" class="mb-8 hidden">
                        <div class="border-3 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer relative group bg-slate-50">
                            <input type="file" id="fileInput" accept=".pdf,.epub" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect()">
                            <div class="group-hover:scale-105 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-300 mb-2"></i>
                                <p class="text-sm text-gray-500">Glissez votre PDF ou EPUB ici</p>
                            </div>
                            <p id="file-name" class="text-blue-600 font-bold mt-2 text-sm bg-white inline-block px-4 py-1 rounded-full shadow-sm hidden"></p>
                        </div>
                    </div>

                    <div id="zone-text" class="mb-8 hidden space-y-4">
                        <input type="text" id="rawTitle" placeholder="Titre du cours" class="w-full border p-3 rounded-lg font-bold outline-none focus:ring-2 ring-blue-500" oninput="checkManualInput()">
                        <textarea id="rawText" rows="15" class="w-full border p-3 rounded-lg font-mono text-sm outline-none focus:ring-2 ring-blue-500" placeholder='Collez votre JSON ou texte ici...' oninput="checkManualInput()"></textarea>
                    </div>

                    <div class="mb-8 bg-orange-50 p-6 rounded-xl border border-orange-100">
                        <input type="text" id="audioInput" class="w-full border border-orange-200 p-3 rounded-lg text-sm bg-white" placeholder="Lien Audio/MP3 (Optionnel)...">
                    </div>

                    <button onclick="processData()" id="btn-action" class="w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] cursor-not-allowed" disabled>
                        En attente...
                    </button>
                    
                    <div id="status" class="mt-6 text-center text-sm font-bold"></div>
                </div>
            </div>
        </div>

        <div id="view-manage" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-6 flex gap-4">
                    <input type="text" id="manage-search" placeholder="Rechercher..." class="w-full p-4 pl-12 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white transition" onkeyup="renderLessonsList()">
                    <button onclick="fetchAllLessons()" class="bg-gray-100 text-gray-600 px-6 rounded-xl hover:bg-gray-200 font-bold"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs font-bold text-gray-500 uppercase border-b border-gray-200">
                                <th class="py-4 pl-4">Statut</th>
                                <th class="py-4">Titre</th>
                                <th class="py-4">Type</th>
                                <th class="py-4">Mati√®re</th>
                                <th class="py-4 text-right pr-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lessons-list" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-sales" class="hidden">
             <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-xl text-slate-800">Commandes en attente (MVola)</h2>
                    <button onclick="fetchSales()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-sync-alt mr-2"></i>Actualiser</button>
                </div>
                <div id="sales-list" class="space-y-4"><div class="text-center py-10 text-gray-400">Chargement...</div></div>
            </div>
        </div>

        <div id="view-ads" class="hidden">
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">Ajouter / Modifier Pub</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="ad-id">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label><input type="text" id="ad-image-url" class="w-full p-3 border rounded-lg text-sm" placeholder="https://..."></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lien Clic</label><input type="text" id="ad-link-url" class="w-full p-3 border rounded-lg text-sm" placeholder="https://..."></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><select id="ad-location" class="w-full p-3 border rounded-lg text-sm"><option value="home_top">Accueil (Haut)</option><option value="lesson_sidebar">Barre Lat√©rale</option></select></div>
                        
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date de fin (Optionnel)</label><input type="date" id="ad-end-date" class="w-full p-3 border rounded-lg text-sm text-gray-600"></div>

                        <div class="flex items-center gap-3 py-2">
                            <label class="text-sm font-bold text-gray-600">Actif imm√©diatement ?</label>
                            <input type="checkbox" id="ad-active" class="h-5 w-5 text-blue-600" checked>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="saveAd()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">Enregistrer</button>
                            <button onclick="resetAdForm()" class="px-4 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 font-bold hidden" id="btn-cancel-ad">Annuler</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-6 text-slate-700">Pubs Existantes</h2>
                    <div id="ads-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        import { createClient } from "https://esm.run/@supabase/supabase-js";

        // --- CONFIG ---
        const API_KEY_GEMINI = "TOKEN_REMPLACEMENT_ICI"; 
        const SUPABASE_URL = "https://jdxdthxztokjhprwynyf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGR0aHh6dG9ramhwcnd5bnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODAyNzgsImV4cCI6MjA4Mjc1NjI3OH0.zal-p0RKJ-PYGvzal1K9-asbUbyQmqG5OtPTWnoHQmI";
        const ADMIN_EMAIL = "votre-email-admin@gmail.com"; 

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const genAI = new GoogleGenerativeAI(API_KEY_GEMINI);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        let existingData = [], allLessons = [], allAds = [], isNewMode = false;
        let detectedType = null; 

        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            if (session.user.email !== ADMIN_EMAIL) { alert("Acc√®s r√©serv√©."); window.location.href = 'index.html'; return; }

            document.getElementById('body-content').classList.remove('hidden');

            const { data } = await supabase.from('lessons').select('niveau, classe, matiere');
            if(data) {
                existingData = data;
                const niveaux = [...new Set(data.map(d => d.niveau).filter(n => n))];
                const select = document.getElementById('select-niveau');
                select.innerHTML = '<option value="">-- Choisir --</option>';
                niveaux.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
            }
            fetchAllLessons();
            fetchAds();
            fetchSales();
        };

        window.logout = async function() { await supabase.auth.signOut(); window.location.href = 'login.html'; }

        // --- TABS & UI ---
        window.switchTab = function(t) { 
            ['create','manage','sales','ads'].forEach(id => document.getElementById('view-'+id).classList.toggle('hidden', id !== t));
            ['tab-create','tab-manage','tab-sales','tab-ads'].forEach(id => {
                const btn = document.getElementById(id);
                if(id === 'tab-'+t) btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white";
                else btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50";
            });
            if(t === 'manage') fetchAllLessons();
            if(t === 'sales') fetchSales();
            if(t === 'ads') fetchAds();
        }

        window.toggleSource = function(mode) {
            const btnFile = document.getElementById('btn-source-file');
            const btnManual = document.getElementById('btn-source-manual');
            const zoneUpload = document.getElementById('zone-upload');
            const zoneText = document.getElementById('zone-text');

            btnFile.className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'file' ? "active-source" : "border-gray-200 bg-white text-gray-500");
            btnManual.className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'manual' ? "active-source" : "border-gray-200 bg-white text-gray-500");

            if(mode === 'file') {
                zoneUpload.classList.remove('hidden'); zoneText.classList.add('hidden');
                document.getElementById('library-options').classList.add('hidden');
                detectedType = null; disableButton();
            } else {
                zoneUpload.classList.add('hidden'); zoneText.classList.remove('hidden');
                document.getElementById('library-options').classList.add('hidden');
                detectedType = 'manual'; checkManualInput();
            }
        }

        // --- PROCESS DATA ---
        window.processData = async function() {
            const statusDiv = document.getElementById('status');
            const file = document.getElementById('fileInput').files[0];
            const editId = document.getElementById('edit-mode-id').value;
            let niveau = isNewMode ? document.getElementById('new-niveau').value : document.getElementById('select-niveau').value;
            let classe = isNewMode ? document.getElementById('new-classe').value : document.getElementById('select-classe').value;
            let matiere = isNewMode ? document.getElementById('new-matiere').value : document.getElementById('select-matiere').value;
            const isPublie = document.getElementById('check-publie').checked;
            
            if (!detectedType) return alert("S√©lectionnez une source");
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

            try {
                let dbObjects = [];
                let fileUrl = null;

                if (detectedType === 'epub' && file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await supabase.storage.from('library').upload(fileName, file);
                    const { data } = supabase.storage.from('library').getPublicUrl(fileName);
                    fileUrl = data.publicUrl;
                    
                    dbObjects = [{ 
                        niveau, classe, matiere, 
                        titre: file.name.replace('.epub', ''), 
                        type_contenu: 'livre_bibliotheque', 
                        file_url: fileUrl, 
                        auteur: document.getElementById('meta-auteur').value, 
                        genre: document.getElementById('meta-genre').value,
                        image_couverture: document.getElementById('meta-cover').value,
                        est_publie: isPublie 
                    }];
                } 
                else if (detectedType === 'pdf' && file && !editId) {
                    const base64File = await fileToBase64(file);
                    const prompt = `Transforme ce PDF en le√ßon HTML JSON structur√©.`;
                    const result = await model.generateContent([prompt, base64File]);
                    let json = result.response.text().replace(/```json|```/g, '').trim();
                    dbObjects = JSON.parse(json).map(l => ({ 
                        niveau, classe, matiere, titre: l.titre, 
                        contenu_html: JSON.stringify(l), 
                        type_contenu: 'pdf_genere', 
                        audio_url: document.getElementById('audioInput').value,
                        est_publie: isPublie 
                    }));
                } 
                else if (detectedType === 'manual') {
                    dbObjects = [{ 
                        niveau, classe, matiere, 
                        titre: document.getElementById('rawTitle').value, 
                        contenu_html: document.getElementById('rawText').value, 
                        type_contenu: 'manuel', 
                        audio_url: document.getElementById('audioInput').value,
                        est_publie: isPublie 
                    }];
                }

                if(editId) await supabase.from('lessons').update(dbObjects[0]).eq('id', editId);
                else await supabase.from('lessons').insert(dbObjects);
                
                statusDiv.innerHTML = '‚úÖ Succ√®s !'; 
                setTimeout(() => window.location.reload(), 1000);
            } catch(e) { statusDiv.innerHTML = 'Erreur: ' + e.message; }
        }

        // --- GESTION CONTENU ---
        window.fetchAllLessons = async function() { 
            const { data } = await supabase.from('lessons').select('*').order('id', { ascending: false }); 
            allLessons = data || []; 
            renderLessonsList(); 
        }

        window.renderLessonsList = function() { 
            const q = document.getElementById('manage-search').value.toLowerCase(); 
            document.getElementById('lessons-list').innerHTML = allLessons.filter(l => l.titre.toLowerCase().includes(q)).map(l => {
                const statusColor = l.est_publie ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                const statusIcon = l.est_publie ? 'fa-check-circle' : 'fa-clock';
                const statusText = l.est_publie ? 'Publi√©' : 'Brouillon';
                
                return `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="pl-4 py-3">
                        <button onclick="toggleLessonStatus(${l.id}, ${l.est_publie})" class="${statusColor} px-2 py-1 rounded text-xs font-bold flex items-center gap-1 hover:opacity-80 transition">
                            <i class="fas ${statusIcon}"></i> ${statusText}
                        </button>
                    </td>
                    <td class="font-bold text-slate-700">${l.titre}</td>
                    <td class="text-xs text-gray-500">${l.type_contenu}</td>
                    <td class="text-gray-500 text-sm">${l.matiere || '-'}</td>
                    <td class="text-right pr-4">
                        <button onclick="editLesson(${l.id})" class="text-blue-600 bg-blue-50 w-8 h-8 rounded-full hover:bg-blue-100 mr-2 transition"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="deleteLesson(${l.id})" class="text-red-600 bg-red-50 w-8 h-8 rounded-full hover:bg-red-100 transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join(''); 
        }

        window.toggleLessonStatus = async function(id, currentStatus) {
            await supabase.from('lessons').update({ est_publie: !currentStatus }).eq('id', id);
            fetchAllLessons();
        }

        window.editLesson = async function(id) { 
            const { data } = await supabase.from('lessons').select('*').eq('id', id).single(); 
            switchTab('create'); 
            
            if(data.type_contenu === 'livre_bibliotheque') {
                toggleSource('file'); document.getElementById('library-options').classList.remove('hidden'); detectedType = 'epub';
            } else { toggleSource('manual'); }
            
            document.getElementById('edit-mode-id').value = id; 
            document.getElementById('rawTitle').value = data.titre; 
            document.getElementById('audioInput').value = data.audio_url || "";
            document.getElementById('check-publie').checked = data.est_publie;
            
            // Meta Biblio
            document.getElementById('meta-auteur').value = data.auteur || "";
            document.getElementById('meta-genre').value = data.genre || "";
            document.getElementById('meta-cover').value = data.image_couverture || "";

            let contentStr = data.contenu_html;
            try { if(typeof data.contenu_html === 'object') contentStr = JSON.stringify(data.contenu_html, null, 2); } catch(e){}
            document.getElementById('rawText').value = contentStr; 
            document.getElementById('form-title').innerText = "Modifier : " + data.titre;
            checkManualInput(); 
        }
        
        window.deleteLesson = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('lessons').delete().eq('id', id); fetchAllLessons(); } }

        // --- GESTION PUBS (AM√âLIOR√âE) ---
        window.fetchAds = async function() { 
            const { data } = await supabase.from('ads').select('*').order('created_at', { ascending: false }); 
            allAds = data || []; 
            renderAdsList(); 
        }

        window.renderAdsList = function() { 
            document.getElementById('ads-list').innerHTML = allAds.map(ad => {
                const isExpired = ad.date_fin && new Date(ad.date_fin) < new Date();
                const statusClass = (ad.actif && !isExpired) ? "bg-green-100 border-green-200" : "bg-gray-50 border-gray-200 opacity-70";
                
                return `
                <div class="flex items-center gap-4 p-4 border rounded-xl transition ${statusClass}">
                    <img src="${ad.image_url}" class="w-20 h-12 object-cover rounded border bg-white">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold uppercase text-gray-500">${ad.emplacement}</span>
                            ${isExpired ? '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded">Expir√©</span>' : ''}
                        </div>
                        <div class="text-sm font-bold text-blue-600 truncate">${ad.link_url}</div>
                        <div class="text-xs text-gray-400">${ad.date_fin ? 'Fin: ' + new Date(ad.date_fin).toLocaleDateString() : 'Illimit√©'}</div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="toggleAdStatus(${ad.id}, ${ad.actif})" class="${ad.actif ? 'text-green-600' : 'text-gray-400'} hover:scale-110 transition"><i class="fas fa-power-off text-lg"></i></button>
                         <button onclick="editAd(${ad.id})" class="text-blue-500 hover:scale-110 transition"><i class="fas fa-edit"></i></button>
                         <button onclick="deleteAd(${ad.id})" class="text-red-500 hover:scale-110 transition"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join(''); 
        }

        window.saveAd = async function() { 
            const id = document.getElementById('ad-id').value;
            const img = document.getElementById('ad-image-url').value; 
            const link = document.getElementById('ad-link-url').value; 
            const loc = document.getElementById('ad-location').value; 
            const dateFin = document.getElementById('ad-end-date').value || null;
            const actif = document.getElementById('ad-active').checked;

            if(!img) return alert("Image obligatoire");
            const adObj = { image_url: img, link_url: link, emplacement: loc, date_fin: dateFin, actif: actif };
            
            if(id) await supabase.from('ads').update(adObj).eq('id', id);
            else await supabase.from('ads').insert([adObj]);
            resetAdForm(); fetchAds(); 
        }

        window.editAd = async function(id) {
            const ad = allAds.find(a => a.id === id);
            if(!ad) return;
            document.getElementById('ad-id').value = ad.id;
            document.getElementById('ad-image-url').value = ad.image_url;
            document.getElementById('ad-link-url').value = ad.link_url;
            document.getElementById('ad-location').value = ad.emplacement;
            if(ad.date_fin) document.getElementById('ad-end-date').value = ad.date_fin.split('T')[0];
            document.getElementById('ad-active').checked = ad.actif;
            document.getElementById('btn-cancel-ad').classList.remove('hidden');
        }

        window.toggleAdStatus = async function(id, currentStatus) { await supabase.from('ads').update({ actif: !currentStatus }).eq('id', id); fetchAds(); }
        window.deleteAd = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('ads').delete().eq('id', id); fetchAds(); } }
        window.resetAdForm = function() {
            document.getElementById('ad-id').value = ''; document.getElementById('ad-image-url').value = ''; document.getElementById('ad-link-url').value = ''; document.getElementById('ad-end-date').value = ''; document.getElementById('ad-active').checked = true; document.getElementById('btn-cancel-ad').classList.add('hidden');
        }

        // --- SALES & UTILS ---
        window.fetchSales = async function() { /* Code inchang√© */ const list = document.getElementById('sales-list'); list.innerHTML = '<div class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>'; const { data: achats, error } = await supabase.from('achats').select('*').eq('statut', 'en_attente').order('created_at', { ascending: false }); if(error) { list.innerHTML = `<div class="text-red-500">Erreur: ${error.message}</div>`; return; } if(!achats || achats.length === 0) { list.innerHTML = '<div class="text-center py-10 bg-gray-50 rounded-xl text-gray-500 font-bold">Aucune commande en attente.</div>'; return; } list.innerHTML = ''; for (const achat of achats) { const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', achat.user_id).single(); let produit = achat.montant >= 10000 ? `üíé ABONNEMENT (${achat.montant} Ar)` : "üìò Livre"; if(achat.montant < 10000) { const { data: book } = await supabase.from('lessons').select('titre').eq('id', achat.document_id).maybeSingle(); if(book) produit = `üìò ${book.titre}`; } list.innerHTML += `<div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm mb-4"><div class="flex justify-between gap-4"><div class="flex-1"><h3 class="font-black text-lg text-slate-800 mb-2">${produit}</h3><div class="text-sm bg-slate-50 p-3 rounded-lg"><p>üë§ Client: <span class="font-bold">${userProfile ? userProfile.prenom : "Inconnu"}</span></p><p>üí∞ Montant: <span class="font-bold text-green-600">${achat.montant} Ar</span></p><p>üìù R√©f: <span class="font-mono font-bold text-blue-600">${achat.ref_transaction}</span></p></div></div><div class="flex flex-col justify-center gap-2"><button onclick="validateSale('${achat.id}', ${achat.montant}, '${achat.user_id}')" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg shadow">Valider</button><button onclick="deleteSale('${achat.id}')" class="px-6 py-2 text-red-500 border border-red-200 rounded-lg">Refuser</button></div></div></div>`; } }
        window.validateSale = async function(id, montant, userId) { /* Code inchang√© */ if(!confirm(`Valider la r√©ception de ${montant} Ar ?`)) return; await supabase.from('achats').update({ statut: 'valide', date_validation: new Date() }).eq('id', id); if (montant >= 10000) { let jours = montant >= 50000 ? 180 : (montant >= 27000 ? 90 : 30); const dateFin = new Date(); dateFin.setDate(dateFin.getDate() + jours); await supabase.from('profiles').update({ statut: 'premium', date_fin_abonnement: dateFin.toISOString() }).eq('id', userId); alert(`‚úÖ Abonnement ${jours} jours activ√© !`); } else { alert("‚úÖ Achat valid√© !"); } fetchSales(); }
        window.deleteSale = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('achats').delete().eq('id', id); fetchSales(); } };
        window.handleFileSelect = function() { /* Code inchang√© */ const file = document.getElementById('fileInput').files[0]; const btn = document.getElementById('btn-action'); const fileNameDisp = document.getElementById('file-name'); if (!file) return; fileNameDisp.innerText = "üìÑ " + file.name; fileNameDisp.classList.remove('hidden'); if (file.name.toLowerCase().endsWith('.epub')) { detectedType = 'epub'; document.getElementById('library-options').classList.remove('hidden'); btn.className = "w-full bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; btn.innerHTML = 'Ajouter √† la Biblioth√®que'; btn.disabled = false; } else { detectedType = 'pdf'; document.getElementById('library-options').classList.add('hidden'); btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; btn.innerHTML = 'G√©n√©rer Cours IA (PDF)'; btn.disabled = false; } }
        window.checkManualInput = function() { /* Code inchang√© */ const t = document.getElementById('rawTitle').value; const c = document.getElementById('rawText').value; const b = document.getElementById('btn-action'); if(t&&c){ b.disabled=false; b.className="w-full bg-green-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; b.innerHTML="Enregistrer le cours"; } else { b.disabled=true; b.className="w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg cursor-not-allowed"; } }
        function fileToBase64(file) { return new Promise((r, j) => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r({ inlineData: { data: rd.result.split(',')[1], mimeType: file.type } }); rd.onerror = e => j(e); }); }
        window.loadClasses = function() { const niv = document.getElementById('select-niveau').value; const select = document.getElementById('select-classe'); const classes = [...new Set(existingData.filter(d => d.niveau === niv).map(d => d.classe))]; select.innerHTML = '<option value="">-- Choisir --</option>'; classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`); }
        window.loadMatieres = function() { const niv = document.getElementById('select-niveau').value; const cls = document.getElementById('select-classe').value; const select = document.getElementById('select-matiere'); const matieres = [...new Set(existingData.filter(d => d.niveau === niv && d.classe === cls).map(d => d.matiere))]; select.innerHTML = '<option value="">-- Choisir --</option>'; matieres.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`); }
        window.cancelEditMode = function() { isNewMode = false; document.getElementById('edit-mode-id').value = ''; document.getElementById('rawTitle').value = ''; document.getElementById('rawText').value = ''; toggleSource('file'); document.getElementById('form-title').innerText = "2. Contenu du Cours"; document.getElementById('btn-cancel-edit-mode').classList.add('hidden'); document.getElementById('check-publie').checked = false; }
        window.toggleNewForm = function() { isNewMode = !isNewMode; document.getElementById('new-form').classList.toggle('hidden', !isNewMode); document.getElementById('select-niveau').disabled = isNewMode; }
    </script>
</body>
</html>
