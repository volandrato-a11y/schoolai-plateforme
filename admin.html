<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Studio SchoolAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 hidden" id="body-content">

    <div class="max-w-6xl mx-auto py-8 px-4">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-black text-blue-900"><i class="fas fa-magic text-blue-600 mr-3"></i>Studio SchoolAI</h1>
            <div class="flex gap-4 items-center mt-4 md:mt-0">
                <a href="index.html" class="text-gray-500 hover:text-blue-600 font-bold text-sm flex items-center">Voir le site <i class="fas fa-external-link-alt ml-2"></i></a>
                <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-100 transition border border-red-200"><i class="fas fa-sign-out-alt mr-2"></i>D√©connexion</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <button onclick="switchTab('create')" id="tab-create" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white"><i class="fas fa-plus-circle mr-2"></i>Cr√©er</button>
            <button onclick="switchTab('manage')" id="tab-manage" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-tasks mr-2"></i>Contenu</button>
            <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-money-bill-wave mr-2"></i>Ventes (MVola)</button>
            <button onclick="switchTab('ads')" id="tab-ads" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-ad mr-2"></i>Pubs</button>
        </div>

        <div id="view-create" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-4">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">1. Classement</h2>
                    <input type="hidden" id="edit-mode-id" value="">
                    <div class="space-y-4">
                        <select id="select-niveau" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadClasses()"><option value="">Chargement...</option></select>
                        <select id="select-classe" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadMatieres()"><option value="">-- D'abord le niveau --</option></select>
                        <select id="select-matiere" class="w-full p-3 border rounded-xl bg-gray-50"><option value="">-- D'abord la classe --</option></select>
                    </div>
                    <div id="library-options" class="hidden mt-6 pt-6 border-t border-gray-100 animate-fade-in bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h3 class="font-bold text-sm text-purple-700 mb-3"><i class="fas fa-book mr-2"></i>Info Biblioth√®que</h3>
                        <div class="space-y-3">
                            <input type="text" id="meta-auteur" placeholder="Auteur" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <select id="meta-genre" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white font-bold text-gray-600">
                                <option value="">-- Cat√©gorie --</option>
                                <option value="Roman">üìñ Roman</option><option value="Manuel">üìò Manuel</option><option value="Cours">üéì Cours</option><option value="Jeunesse">üß∏ Jeunesse</option><option value="BD">üí≠ BD/Manga</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative py-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div><div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400 font-bold">Ou cr√©er nouveau</span></div></div>
                    <button onclick="toggleNewForm()" class="w-full py-3 text-sm text-blue-600 font-bold border border-blue-100 bg-blue-50 rounded-xl hover:bg-blue-100 transition"><i class="fas fa-plus-circle mr-2"></i>Nouvelle Mati√®re</button>
                    <div id="new-form" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <select id="new-niveau" class="w-full mb-3 p-2 text-sm border rounded-lg font-bold text-blue-900"><option value="Primaire">Primaire</option><option value="Coll√®ge">Coll√®ge</option><option value="Lyc√©e">Lyc√©e</option><option value="Formation Pro">Pro</option></select>
                        <input id="new-classe" type="text" placeholder="Classe" class="w-full mb-3 p-2 text-sm border rounded-lg">
                        <input id="new-matiere" type="text" placeholder="Mati√®re" class="w-full p-2 text-sm border rounded-lg">
                    </div>
                    <button id="btn-cancel-edit-mode" onclick="cancelEditMode()" class="hidden w-full mt-4 py-3 text-gray-600 font-bold border border-gray-300 bg-gray-100 rounded-xl hover:bg-gray-200 transition"><i class="fas fa-times mr-2"></i> Annuler</button>
                </div>
            </div>
            <div class="lg:col-span-8">
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-blue-600 relative">
                    <h2 class="font-bold text-xl mb-6 text-slate-800 border-b pb-2" id="form-title">2. Fichier Source ou Modification</h2>
                    <div id="mode-indicator" class="mb-6 p-4 rounded-lg bg-gray-50 border border-gray-200 text-center text-gray-500 text-sm font-bold transition-all duration-300">En attente d'un fichier PDF ou EPUB...</div>
                    <div id="zone-upload" class="mb-8">
                        <div class="border-3 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer relative group bg-slate-50">
                            <input type="file" id="fileInput" accept=".pdf,.epub" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect()">
                            <div class="group-hover:scale-105 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-300 mb-2"></i>
                                <p class="text-sm text-gray-500">Glissez votre PDF ou EPUB ici</p>
                            </div>
                            <p id="file-name" class="text-blue-600 font-bold mt-2 text-sm bg-white inline-block px-4 py-1 rounded-full shadow-sm hidden"></p>
                        </div>
                    </div>
                    <div class="mb-8 bg-orange-50 p-6 rounded-xl border border-orange-100"><input type="text" id="audioInput" class="w-full border border-orange-200 p-3 rounded-lg text-sm" placeholder="Lien Audio/MP3 (Optionnel)..."></div>
                    <div id="zone-text" class="mb-8 hidden space-y-4 border-t pt-4"><div class="text-xs font-bold text-gray-400 uppercase">√âditeur Manuel (HTML)</div><input type="text" id="rawTitle" placeholder="Titre" class="w-full border p-3 rounded-lg font-bold"><textarea id="rawText" rows="10" class="w-full border p-3 rounded-lg font-mono text-sm" placeholder="Contenu HTML..."></textarea></div>
                    <button onclick="processData()" id="btn-action" class="w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] cursor-not-allowed" disabled>En attente...</button>
                    <div id="status" class="mt-6 text-center text-sm font-bold"></div>
                </div>
            </div>
        </div>

        <div id="view-manage" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-6 flex gap-4">
                    <input type="text" id="manage-search" placeholder="Rechercher..." class="w-full p-4 pl-12 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white transition" onkeyup="renderLessonsList()">
                    <button onclick="fetchAllLessons()" class="bg-gray-100 text-gray-600 px-6 rounded-xl hover:bg-gray-200 font-bold"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="text-xs font-bold text-gray-500 uppercase border-b border-gray-200"><th class="py-4">Titre</th><th class="py-4">Type</th><th class="py-4">Mati√®re</th><th class="py-4 text-right">Actions</th></tr></thead><tbody id="lessons-list" class="text-sm"></tbody></table></div>
            </div>
        </div>

        <div id="view-sales" class="hidden">
             <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-xl text-slate-800">Commandes en attente (MVola)</h2>
                    <button onclick="fetchSales()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-sync-alt mr-2"></i>Actualiser</button>
                </div>
                <div id="sales-list" class="space-y-4"><div class="text-center py-10 text-gray-400">Chargement...</div></div>
            </div>
        </div>

        <div id="view-ads" class="hidden">
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">Ajouter Pub</h2>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label><input type="text" id="ad-image-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lien Clic</label><input type="text" id="ad-link-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><select id="ad-location" class="w-full p-3 border rounded-lg text-sm"><option value="home_top">Accueil</option><option value="lesson_sidebar">Le√ßon Sidebar</option></select></div>
                        <button onclick="addAd()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">Ajouter</button>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-6 text-slate-700">Pubs Actives</h2>
                    <div id="ads-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        import { createClient } from "https://esm.run/@supabase/supabase-js";

        // --- CONFIGURATION ---
        // ICI : On utilise le placeholder pour Netlify
        const API_KEY_GEMINI = "TOKEN_REMPLACEMENT_ICI"; 
        const SUPABASE_URL = "https://jdxdthxztokjhprwynyf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGR0aHh6dG9ramhwcnd5bnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODAyNzgsImV4cCI6MjA4Mjc1NjI3OH0.zal-p0RKJ-PYGvzal1K9-asbUbyQmqG5OtPTWnoHQmI";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const genAI = new GoogleGenerativeAI(API_KEY_GEMINI);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        let existingData = [], allLessons = [], allAds = [], isNewMode = false;
        let detectedType = null;

        // --- INITIALISATION AVEC SECURIT√â ---
        window.onload = async function() {
            // 1. V√©rification Connexion (La s√©curit√© est r√©tablie ici)
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            document.getElementById('body-content').classList.remove('hidden');

            // 2. Chargement donn√©es
            const { data } = await supabase.from('lessons').select('niveau, classe, matiere');
            if(data) {
                existingData = data;
                const niveaux = [...new Set(data.map(d => d.niveau).filter(n => n))];
                const select = document.getElementById('select-niveau');
                select.innerHTML = '<option value="">-- Choisir --</option>';
                niveaux.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
            }
            fetchAllLessons();
            fetchAds();
            fetchSales();
        };

        window.logout = async function() { await supabase.auth.signOut(); window.location.href = 'login.html'; }

        // --- GESTION TABS & UI ---
        window.switchTab = function(t) { 
            ['create','manage','sales','ads'].forEach(id => document.getElementById('view-'+id).classList.toggle('hidden', id !== t));
            ['tab-create','tab-manage','tab-sales','tab-ads'].forEach(id => {
                const btn = document.getElementById(id);
                if(id === 'tab-'+t) btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white";
                else btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50";
            });
            if(t === 'manage') fetchAllLessons();
            if(t === 'sales') fetchSales();
        }

        // --- SALES (MVola) ---
        window.fetchSales = async function() {
            const list = document.getElementById('sales-list');
            list.innerHTML = '<div class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
            const { data: achats, error } = await supabase.from('achats').select('*').eq('statut', 'en_attente').order('created_at', { ascending: false });
            if(error) { list.innerHTML = `<div class="text-red-500">Erreur: ${error.message}</div>`; return; }
            if(!achats || achats.length === 0) { list.innerHTML = '<div class="text-center py-10 bg-gray-50 rounded-xl text-gray-500 font-bold">Aucune commande en attente.</div>'; return; }
            list.innerHTML = '';
            for (const achat of achats) {
                const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', achat.user_id).single();
                let bookTitle = "Livre inconnu (" + achat.document_id + ")";
                const { data: book } = await supabase.from('lessons').select('titre').eq('id', achat.document_id).maybeSingle();
                if(book) bookTitle = book.titre;
                const nomClient = userProfile ? `${userProfile.prenom} ${userProfile.nom}` : "Client Inconnu";
                const telClient = userProfile ? userProfile.telephone : "N/A";
                const dateCmd = new Date(achat.created_at).toLocaleString('fr-FR');
                list.innerHTML += `<div class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm animate-fade-in"><div class="flex-1"><div class="flex items-center gap-2 mb-2"><span class="bg-yellow-200 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wide">En attente</span><span class="text-gray-400 text-xs">${dateCmd}</span></div><h3 class="font-black text-lg text-slate-800 mb-1">${bookTitle}</h3><p class="text-sm text-gray-600">üë§ Client : <span class="font-bold">${nomClient}</span></p><p class="text-sm text-gray-600">üì± T√©l : <span class="font-mono font-bold bg-white px-1 rounded border">${telClient}</span></p></div><div class="flex gap-3 w-full md:w-auto"><button onclick="deleteSale('${achat.id}')" class="flex-1 md:flex-none px-4 py-2 text-red-500 font-bold text-sm border border-red-200 rounded-lg hover:bg-red-50 transition">Refuser</button><button onclick="validateSale('${achat.id}')" class="flex-1 md:flex-none px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow hover:bg-green-600 transition transform hover:scale-105 flex items-center gap-2"><i class="fas fa-check-circle"></i> Valider (500 Ar)</button></div></div>`;
            }
        };
        window.validateSale = async function(id) { if(!confirm("Re√ßu l'argent ?")) return; await supabase.from('achats').update({ statut: 'valide', date_validation: new Date() }).eq('id', id); fetchSales(); };
        window.deleteSale = async function(id) { if(!confirm("Supprimer ?")) return; await supabase.from('achats').delete().eq('id', id); fetchSales(); };

        // --- CORE FUNCTIONS (Upload & IA) ---
        window.handleFileSelect = function() {
            const file = document.getElementById('fileInput').files[0];
            const indicator = document.getElementById('mode-indicator');
            const libOptions = document.getElementById('library-options');
            const btn = document.getElementById('btn-action');
            const fileNameDisp = document.getElementById('file-name');
            if (!file) { if(document.getElementById('rawText').value.length > 0) { enableSaveButton(); return; } detectedType = null; indicator.innerHTML = "En attente..."; libOptions.classList.add('hidden'); btn.disabled = true; fileNameDisp.classList.add('hidden'); return; }
            fileNameDisp.innerText = "üìÑ " + file.name; fileNameDisp.classList.remove('hidden');
            if (file.name.toLowerCase().endsWith('.epub')) { detectedType = 'epub'; indicator.innerHTML = `EPUB D√âTECT√â`; libOptions.classList.remove('hidden'); btn.innerHTML = 'Ajouter Biblio'; btn.disabled = false; btn.className = "w-full bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; } 
            else { detectedType = 'pdf'; indicator.innerHTML = `PDF D√âTECT√â`; libOptions.classList.add('hidden'); btn.innerHTML = 'G√©n√©rer Cours IA'; btn.disabled = false; btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; }
        }
        function enableSaveButton() { const btn = document.getElementById('btn-action'); btn.disabled = false; btn.className = "w-full bg-green-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg"; btn.innerHTML = 'Enregistrer'; }
        
        window.processData = async function() {
            const statusDiv = document.getElementById('status');
            const file = document.getElementById('fileInput').files[0];
            const editId = document.getElementById('edit-mode-id').value;
            let niveau = isNewMode ? document.getElementById('new-niveau').value : document.getElementById('select-niveau').value;
            let classe = isNewMode ? document.getElementById('new-classe').value : document.getElementById('select-classe').value;
            let matiere = isNewMode ? document.getElementById('new-matiere').value : document.getElementById('select-matiere').value;
            if (detectedType === 'epub' && !document.getElementById('meta-genre').value) return alert("Genre requis !");
            if (!file && !document.getElementById('rawText').value) return alert("Rien √† traiter");
            statusDiv.innerHTML = 'Traitement...';
            try {
                let fileUrl = null, dbObjects = [];
                if (file && detectedType === 'epub') {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await supabase.storage.from('library').upload(fileName, file);
                    const { data } = supabase.storage.from('library').getPublicUrl(fileName);
                    fileUrl = data.publicUrl;
                }
                if (file && !editId && detectedType !== 'epub') {
                    const base64File = await fileToBase64(file);
                    const prompt = `Transforme ce PDF en le√ßon HTML JSON : [{ "titre": "...", "html_content": "...", "quiz": [...] }]`;
                    const result = await model.generateContent([prompt, base64File]);
                    let json = result.response.text().replace(/```json|```/g, '').trim();
                    dbObjects = JSON.parse(json).map(l => ({ niveau, classe, matiere, titre: l.titre, contenu_html: l.html_content, quiz: l.quiz, type_contenu: 'pdf_genere', file_url: fileUrl, audio_url: document.getElementById('audioInput').value }));
                } else if (detectedType === 'epub') {
                    dbObjects = [{ niveau, classe, matiere, titre: file.name.replace('.epub', ''), type_contenu: 'livre_bibliotheque', file_url: fileUrl, auteur: document.getElementById('meta-auteur').value, genre: document.getElementById('meta-genre').value, contenu_html: '<p>Livre</p>', is_published: true }];
                } else {
                    dbObjects = [{ niveau, classe, matiere, titre: document.getElementById('rawTitle').value, contenu_html: document.getElementById('rawText').value, type_contenu: 'pdf_genere', audio_url: document.getElementById('audioInput').value }];
                }
                if(editId) await supabase.from('lessons').update(dbObjects[0]).eq('id', editId);
                else await supabase.from('lessons').insert(dbObjects);
                statusDiv.innerHTML = '‚úÖ Succ√®s !'; setTimeout(() => window.location.reload(), 2000);
            } catch(e) { statusDiv.innerHTML = 'Erreur: ' + e.message; }
        }

        window.editLesson = async function(id) { const { data } = await supabase.from('lessons').select('*').eq('id', id).single(); switchTab('create'); document.getElementById('edit-mode-id').value = id; document.getElementById('rawTitle').value = data.titre; document.getElementById('rawText').value = typeof data.contenu_html === 'string' ? data.contenu_html : JSON.stringify(data.contenu_html); document.getElementById('zone-text').classList.remove('hidden'); enableSaveButton(); }
        window.deleteLesson = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('lessons').delete().eq('id', id); fetchAllLessons(); } }
        window.fetchAllLessons = async function() { const { data } = await supabase.from('lessons').select('*').order('id', { ascending: false }); allLessons = data || []; renderLessonsList(); }
        window.renderLessonsList = function() { const q = document.getElementById('manage-search').value.toLowerCase(); document.getElementById('lessons-list').innerHTML = allLessons.filter(l => l.titre.toLowerCase().includes(q)).map(l => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-2 font-bold">${l.titre}</td><td class="text-xs text-gray-500">${l.type_contenu}</td><td class="text-gray-500 text-sm">${l.matiere || '-'}</td><td class="text-right px-2"><button onclick="editLesson(${l.id})" class="text-blue-600 mr-2">‚úèÔ∏è</button><button onclick="deleteLesson(${l.id})" class="text-red-600">üóëÔ∏è</button></td></tr>`).join(''); }
        
        window.fetchAds = async function() { const { data } = await supabase.from('ads').select('*').order('created_at', { ascending: false }); allAds = data || []; renderAdsList(); }
        window.renderAdsList = function() { document.getElementById('ads-list').innerHTML = allAds.map(ad => `<div class="flex items-center gap-4 bg-gray-50 p-4 border rounded"><img src="${ad.image_url}" class="w-16 h-10 object-cover"><div class="flex-1 text-sm font-bold text-blue-600 truncate">${ad.link_url}</div><button onclick="deleteAd(${ad.id})" class="text-red-500">üóëÔ∏è</button></div>`).join(''); }
        window.addAd = async function() { const img = document.getElementById('ad-image-url').value; const link = document.getElementById('ad-link-url').value; const loc = document.getElementById('ad-location').value; if(!img) return; await supabase.from('ads').insert([{ image_url: img, link_url: link, emplacement: loc }]); fetchAds(); }
        window.deleteAd = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('ads').delete().eq('id', id); fetchAds(); } }
        
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: file.type } }); reader.onerror = error => reject(error); }); }
        window.loadClasses = function() { const niv = document.getElementById('select-niveau').value; const select = document.getElementById('select-classe'); const classes = [...new Set(existingData.filter(d => d.niveau === niv).map(d => d.classe))]; select.innerHTML = '<option value="">-- Choisir --</option>'; classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`); }
        window.loadMatieres = function() { const niv = document.getElementById('select-niveau').value; const cls = document.getElementById('select-classe').value; const select = document.getElementById('select-matiere'); const matieres = [...new Set(existingData.filter(d => d.niveau === niv && d.classe === cls).map(d => d.matiere))]; select.innerHTML = '<option value="">-- Choisir --</option>'; matieres.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`); }
        window.toggleNewForm = function() { isNewMode = !isNewMode; document.getElementById('new-form').classList.toggle('hidden', !isNewMode); document.getElementById('select-niveau').disabled = isNewMode; }
    </script>
</body>
</html>

