<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Supabase</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; }
        .panel { flex: 1; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        input, textarea, select { width: 100%; margin-bottom: 10px; padding: 5px; }
        .item { padding: 10px; background: #f4f4f4; margin-bottom: 5px; border-left: 5px solid orange; }
        .valide { border-left-color: green; opacity: 0.6; }
    </style>
</head>
<body>

<div class="panel">
    <h2>ðŸ“š Ajouter un Livre</h2>
    <form id="form-livre">
        <input type="text" id="titre" placeholder="Titre" required>
        <textarea id="resume" placeholder="RÃ©sumÃ©"></textarea>
        <input type="text" id="coverUrl" placeholder="URL Image Cover" required>
        <input type="text" id="epubUrl" placeholder="URL Fichier EPUB" required>
        <textarea id="jsonData" placeholder='JSON: {"auteur": "Moi"}'></textarea>
        <select id="statut">
            <option value="publie">PubliÃ©</option>
            <option value="gele">GelÃ©</option>
        </select>
        <button type="submit">Ajouter</button>
    </form>
</div>

<div class="panel">
    <h2>ðŸ’° Paiements (Temps RÃ©el)</h2>
    <div id="liste-paiements">Chargement...</div>
</div>

<script type="module">
    import { supabase } from './supabase-config.js';

    // --- 1. AJOUTER LIVRE ---
    document.getElementById('form-livre').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { error } = await supabase.from('livres').insert({
            titre: document.getElementById('titre').value,
            resume: document.getElementById('resume').value,
            cover_url: document.getElementById('coverUrl').value,
            epub_url: document.getElementById('epubUrl').value,
            json_data: JSON.parse(document.getElementById('jsonData').value || '{}'),
            statut: document.getElementById('statut').value
        });

        if (error) alert("Erreur: " + error.message);
        else { alert("Livre ajoutÃ© !"); e.target.reset(); }
    });

    // --- 2. LISTE & VALIDATION ---
    async function fetchTransactions() {
        const { data } = await supabase
            .from('transactions')
            .select('*')
            .order('created_at', { ascending: false });
        
        renderList(data);
    }

    function renderList(data) {
        const container = document.getElementById('liste-paiements');
        container.innerHTML = "";
        data.forEach(t => {
            const div = document.createElement('div');
            div.className = `item ${t.status}`;
            div.innerHTML = `
                <strong>${t.nom_payeur}</strong> (${t.numero_payeur})<br>
                Ref: ${t.transac_id} | Livre ID: ${t.book_id}<br>
                ${t.status === 'en_attente' ? `<button onclick="valider(${t.id})">Valider</button>` : 'âœ… OK'}
            `;
            container.appendChild(div);
        });
    }

    // Fonction globale pour valider
    window.valider = async (id) => {
        await supabase.from('transactions').update({ status: 'valide' }).eq('id', id);
    };

    // Ã‰COUTEUR TEMPS RÃ‰EL (Update auto de l'admin)
    supabase.channel('admin-chan')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, () => {
            fetchTransactions(); // Recharger la liste si changement
        })
        .subscribe();

    fetchTransactions();
</script>
</body>
</html>
