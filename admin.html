<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Studio SchoolAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-source { border-color: #3b82f6 !important; background-color: #eff6ff !important; color: #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 hidden" id="body-content">

    <div class="max-w-6xl mx-auto py-8 px-4">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-black text-blue-900"><i class="fas fa-magic text-blue-600 mr-3"></i>Studio SchoolAI</h1>
            <div class="flex gap-4 items-center mt-4 md:mt-0">
                <a href="index.html" class="text-gray-500 hover:text-blue-600 font-bold text-sm flex items-center">Voir le site <i class="fas fa-external-link-alt ml-2"></i></a>
                <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-100 transition border border-red-200"><i class="fas fa-sign-out-alt mr-2"></i>D√©connexion</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <button onclick="switchTab('create')" id="tab-create" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white"><i class="fas fa-plus-circle mr-2"></i>Cr√©er / Modifier</button>
            <button onclick="switchTab('manage')" id="tab-manage" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-tasks mr-2"></i>Contenu</button>
            <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-money-bill-wave mr-2"></i>Ventes (MVola)</button>
            <button onclick="switchTab('ads')" id="tab-ads" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-ad mr-2"></i>Pubs</button>
        </div>

        <div id="view-create" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-4">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">1. Classement</h2>
                    <input type="hidden" id="edit-mode-id" value="">
                    
                    <div class="space-y-4">
                        <select id="select-niveau" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadClasses()"><option value="">Chargement...</option></select>
                        <select id="select-classe" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadMatieres()"><option value="">-- D'abord le niveau --</option></select>
                        <select id="select-matiere" class="w-full p-3 border rounded-xl bg-gray-50"><option value="">-- D'abord la classe --</option></select>
                    </div>

                    <div id="library-options" class="hidden mt-6 pt-6 border-t border-gray-100 animate-fade-in bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h3 class="font-bold text-sm text-purple-700 mb-3"><i class="fas fa-book mr-2"></i>Info Biblioth√®que</h3>
                        <div class="space-y-3">
                            <input type="text" id="meta-auteur" placeholder="Auteur" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <select id="meta-genre" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white font-bold text-gray-600">
                                <option value="">-- Cat√©gorie --</option>
                                <option value="Roman">üìñ Roman</option><option value="Manuel">üìò Manuel</option><option value="Cours">üéì Cours</option><option value="Jeunesse">üß∏ Jeunesse</option><option value="BD">üí≠ BD/Manga</option>
                            </select>
                        </div>
                    </div>

                    <div class="relative py-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div><div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400 font-bold">Ou cr√©er nouveau</span></div></div>
                    <button onclick="toggleNewForm()" class="w-full py-3 text-sm text-blue-600 font-bold border border-blue-100 bg-blue-50 rounded-xl hover:bg-blue-100 transition"><i class="fas fa-plus-circle mr-2"></i>Nouvelle Mati√®re</button>
                    <div id="new-form" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <select id="new-niveau" class="w-full mb-3 p-2 text-sm border rounded-lg font-bold text-blue-900"><option value="Primaire">Primaire</option><option value="Coll√®ge">Coll√®ge</option><option value="Lyc√©e">Lyc√©e</option><option value="Formation Pro">Pro</option></select>
                        <input id="new-classe" type="text" placeholder="Classe" class="w-full mb-3 p-2 text-sm border rounded-lg">
                        <input id="new-matiere" type="text" placeholder="Mati√®re" class="w-full p-2 text-sm border rounded-lg">
                    </div>
                    
                    <button id="btn-cancel-edit-mode" onclick="cancelEditMode()" class="hidden w-full mt-4 py-3 text-gray-600 font-bold border border-gray-300 bg-gray-100 rounded-xl hover:bg-gray-200 transition"><i class="fas fa-times mr-2"></i> Annuler modif</button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-blue-600 relative">
                    <h2 class="font-bold text-xl mb-6 text-slate-800 border-b pb-2" id="form-title">2. Contenu du Cours</h2>
                    
                    <div id="mode-indicator" class="mb-4 text-center text-gray-500 text-sm font-bold">Choisissez le type de contenu :</div>
                    <div class="flex gap-4 mb-6">
                        <button onclick="toggleSource('file')" id="btn-source-file" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition">
                            <i class="fas fa-file-upload mr-2"></i> Fichier (PDF/EPUB)
                        </button>
                        <button onclick="toggleSource('manual')" id="btn-source-manual" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition">
                            <i class="fas fa-keyboard mr-2"></i> √âditeur JSON / Texte
                        </button>
                    </div>

                    <div id="zone-upload" class="mb-8 hidden">
                        <div class="border-3 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer relative group bg-slate-50">
                            <input type="file" id="fileInput" accept=".pdf,.epub" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect()">
                            <div class="group-hover:scale-105 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-300 mb-2"></i>
                                <p class="text-sm text-gray-500">Glissez votre PDF ou EPUB ici</p>
                            </div>
                            <p id="file-name" class="text-blue-600 font-bold mt-2 text-sm bg-white inline-block px-4 py-1 rounded-full shadow-sm hidden"></p>
                        </div>
                    </div>

                    <div id="zone-text" class="mb-8 hidden space-y-4">
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-xs text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i> Collez ici votre JSON pour activer les onglets (Le√ßon, Quiz, PDF). Sinon, √©crivez du texte simple.
                        </div>
                        <input type="text" id="rawTitle" placeholder="Titre du cours (Obligatoire en manuel)" class="w-full border p-3 rounded-lg font-bold outline-none focus:ring-2 ring-blue-500" oninput="checkManualInput()">
                        <textarea id="rawText" rows="15" class="w-full border p-3 rounded-lg font-mono text-sm outline-none focus:ring-2 ring-blue-500" placeholder='{ "contenu": { "titre": "..." } }' oninput="checkManualInput()"></textarea>
                    </div>

                    <div class="mb-8 bg-orange-50 p-6 rounded-xl border border-orange-100">
                        <input type="text" id="audioInput" class="w-full border border-orange-200 p-3 rounded-lg text-sm bg-white" placeholder="Lien Audio/MP3 (Optionnel)...">
                    </div>

                    <button onclick="processData()" id="btn-action" class="w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] cursor-not-allowed" disabled>
                        En attente...
                    </button>
                    
                    <div id="status" class="mt-6 text-center text-sm font-bold"></div>
                </div>
            </div>
        </div>

        <div id="view-manage" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-6 flex gap-4">
                    <input type="text" id="manage-search" placeholder="Rechercher..." class="w-full p-4 pl-12 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white transition" onkeyup="renderLessonsList()">
                    <button onclick="fetchAllLessons()" class="bg-gray-100 text-gray-600 px-6 rounded-xl hover:bg-gray-200 font-bold"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="text-xs font-bold text-gray-500 uppercase border-b border-gray-200"><th class="py-4">Titre</th><th class="py-4">Type</th><th class="py-4">Mati√®re</th><th class="py-4 text-right">Actions</th></tr></thead><tbody id="lessons-list" class="text-sm"></tbody></table></div>
            </div>
        </div>

        <div id="view-sales" class="hidden">
             <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-xl text-slate-800">Commandes en attente (MVola)</h2>
                    <button onclick="fetchSales()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 transition"><i class="fas fa-sync-alt mr-2"></i>Actualiser</button>
                </div>
                <div id="sales-list" class="space-y-4"><div class="text-center py-10 text-gray-400">Chargement...</div></div>
            </div>
        </div>

        <div id="view-ads" class="hidden">
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">Ajouter Pub</h2>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label><input type="text" id="ad-image-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lien Clic</label><input type="text" id="ad-link-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><select id="ad-location" class="w-full p-3 border rounded-lg text-sm"><option value="home_top">Accueil</option><option value="lesson_sidebar">Le√ßon Sidebar</option></select></div>
                        <button onclick="addAd()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">Ajouter</button>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-6 text-slate-700">Pubs Actives</h2>
                    <div id="ads-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        import { createClient } from "https://esm.run/@supabase/supabase-js";

        // --- CONFIGURATION ADMIN ---
        const API_KEY_GEMINI = "TOKEN_REMPLACEMENT_ICI"; 
        const SUPABASE_URL = "https://jdxdthxztokjhprwynyf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGR0aHh6dG9ramhwcnd5bnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODAyNzgsImV4cCI6MjA4Mjc1NjI3OH0.zal-p0RKJ-PYGvzal1K9-asbUbyQmqG5OtPTWnoHQmI";
        const ADMIN_EMAIL = "volandrato@gmail.com"; 

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const genAI = new GoogleGenerativeAI(API_KEY_GEMINI);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        let existingData = [], allLessons = [], allAds = [], isNewMode = false;
        let detectedType = null; // 'epub', 'pdf', ou 'manual'

        // --- INITIALISATION S√âCURIS√âE ---
        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            if (session.user.email !== ADMIN_EMAIL) { alert("Acc√®s r√©serv√©."); window.location.href = 'index.html'; return; }

            document.getElementById('body-content').classList.remove('hidden');

            const { data } = await supabase.from('lessons').select('niveau, classe, matiere');
            if(data) {
                existingData = data;
                const niveaux = [...new Set(data.map(d => d.niveau).filter(n => n))];
                const select = document.getElementById('select-niveau');
                select.innerHTML = '<option value="">-- Choisir --</option>';
                niveaux.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
            }
            fetchAllLessons();
            fetchAds();
            fetchSales();
        };

        window.logout = async function() { await supabase.auth.signOut(); window.location.href = 'login.html'; }

        // --- UI & TABS ---
        window.switchTab = function(t) { 
            ['create','manage','sales','ads'].forEach(id => document.getElementById('view-'+id).classList.toggle('hidden', id !== t));
            ['tab-create','tab-manage','tab-sales','tab-ads'].forEach(id => {
                const btn = document.getElementById(id);
                if(id === 'tab-'+t) btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white";
                else btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50";
            });
            if(t === 'manage') fetchAllLessons();
            if(t === 'sales') fetchSales();
        }

        window.toggleSource = function(mode) {
            const btnFile = document.getElementById('btn-source-file');
            const btnManual = document.getElementById('btn-source-manual');
            const zoneUpload = document.getElementById('zone-upload');
            const zoneText = document.getElementById('zone-text');

            // Styles boutons
            btnFile.className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'file' ? "active-source" : "border-gray-200 bg-white text-gray-500");
            btnManual.className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'manual' ? "active-source" : "border-gray-200 bg-white text-gray-500");

            if(mode === 'file') {
                zoneUpload.classList.remove('hidden');
                zoneText.classList.add('hidden');
                document.getElementById('library-options').classList.add('hidden');
                detectedType = null;
                disableButton();
            } else {
                zoneUpload.classList.add('hidden');
                zoneText.classList.remove('hidden');
                document.getElementById('library-options').classList.add('hidden');
                detectedType = 'manual';
                checkManualInput();
            }
        }

        // --- GESTION DES VENTES (MVOLA) ---
        window.fetchSales = async function() {
            const list = document.getElementById('sales-list');
            list.innerHTML = '<div class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
            const { data: achats, error } = await supabase.from('achats').select('*').eq('statut', 'en_attente').order('created_at', { ascending: false });
            if(error) { list.innerHTML = `<div class="text-red-500">Erreur: ${error.message}</div>`; return; }
            if(!achats || achats.length === 0) { list.innerHTML = '<div class="text-center py-10 bg-gray-50 rounded-xl text-gray-500 font-bold">Aucune commande en attente.</div>'; return; }
            list.innerHTML = '';
            for (const achat of achats) {
                const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', achat.user_id).single();
                let produit = achat.montant >= 10000 ? `üíé ABONNEMENT (${achat.montant} Ar)` : "üìò Livre (ID: "+achat.document_id+")";
                if(achat.montant < 10000) { const { data: book } = await supabase.from('lessons').select('titre').eq('id', achat.document_id).maybeSingle(); if(book) produit = `üìò ${book.titre}`; }
                
                list.innerHTML += `
                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm mb-4">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex-1">
                                <h3 class="font-black text-lg text-slate-800 mb-2">${produit}</h3>
                                <div class="text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <p>üë§ Client: <span class="font-bold">${userProfile ? userProfile.prenom : "Inconnu"}</span></p>
                                    <p>üí∞ Montant: <span class="font-bold text-green-600">${achat.montant} Ar</span></p>
                                    <p>üìù R√©f: <span class="font-mono font-bold text-blue-600">${achat.ref_transaction}</span> (Nom: ${achat.nom_payeur})</p>
                                </div>
                            </div>
                            <div class="flex flex-col justify-center gap-2">
                                <button onclick="validateSale('${achat.id}', ${achat.montant}, '${achat.user_id}')" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg shadow hover:bg-green-600">Valider</button>
                                <button onclick="deleteSale('${achat.id}')" class="px-6 py-2 text-red-500 border border-red-200 rounded-lg hover:bg-red-50">Refuser</button>
                            </div>
                        </div>
                    </div>`;
            }
        };

        window.validateSale = async function(id, montant, userId) {
            if(!confirm(`Valider la r√©ception de ${montant} Ar ?`)) return;
            await supabase.from('achats').update({ statut: 'valide', date_validation: new Date() }).eq('id', id);
            if (montant >= 10000) {
                let jours = montant >= 50000 ? 180 : (montant >= 27000 ? 90 : 30);
                const dateFin = new Date(); dateFin.setDate(dateFin.getDate() + jours);
                await supabase.from('profiles').update({ statut: 'premium', date_fin_abonnement: dateFin.toISOString() }).eq('id', userId);
                alert(`‚úÖ Abonnement ${jours} jours activ√© !`);
            } else { alert("‚úÖ Achat valid√© !"); }
            fetchSales();
        };
        window.deleteSale = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('achats').delete().eq('id', id); fetchSales(); } };

        // --- TRAITEMENT DES DONN√âES ---
        window.handleFileSelect = function() {
            const file = document.getElementById('fileInput').files[0];
            const btn = document.getElementById('btn-action');
            const fileNameDisp = document.getElementById('file-name');
            if (!file) return;
            fileNameDisp.innerText = "üìÑ " + file.name; fileNameDisp.classList.remove('hidden');
            if (file.name.toLowerCase().endsWith('.epub')) { 
                detectedType = 'epub'; 
                document.getElementById('library-options').classList.remove('hidden');
                btn.className = "w-full bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg";
                btn.innerHTML = 'Ajouter √† la Biblioth√®que';
                btn.disabled = false;
            } else { 
                detectedType = 'pdf'; 
                document.getElementById('library-options').classList.add('hidden');
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg";
                btn.innerHTML = 'G√©n√©rer Cours IA (PDF)';
                btn.disabled = false;
            }
        }

        window.checkManualInput = function() {
            const title = document.getElementById('rawTitle').value;
            const content = document.getElementById('rawText').value;
            const btn = document.getElementById('btn-action');
            if(title && content) {
                btn.disabled = false;
                btn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg";
                btn.innerHTML = "Enregistrer le cours";
            } else { disableButton(); }
        }

        function disableButton() {
            const btn = document.getElementById('btn-action');
            btn.disabled = true; btn.className = "w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg cursor-not-allowed"; btn.innerHTML = "En attente...";
        }

        window.processData = async function() {
            const statusDiv = document.getElementById('status');
            const file = document.getElementById('fileInput').files[0];
            const editId = document.getElementById('edit-mode-id').value;
            let niveau = isNewMode ? document.getElementById('new-niveau').value : document.getElementById('select-niveau').value;
            let classe = isNewMode ? document.getElementById('new-classe').value : document.getElementById('select-classe').value;
            let matiere = isNewMode ? document.getElementById('new-matiere').value : document.getElementById('select-matiere').value;
            
            if (!detectedType) return alert("S√©lectionnez une source (Fichier ou Manuel)");
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement en cours...';

            try {
                let dbObjects = [];
                let fileUrl = null;

                // CAS 1: EPUB
                if (detectedType === 'epub' && file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await supabase.storage.from('library').upload(fileName, file);
                    const { data } = supabase.storage.from('library').getPublicUrl(fileName);
                    fileUrl = data.publicUrl;
                    dbObjects = [{ 
                        niveau, classe, matiere, 
                        titre: file.name.replace('.epub', ''), 
                        type_contenu: 'livre_bibliotheque', 
                        file_url: fileUrl, 
                        auteur: document.getElementById('meta-auteur').value, 
                        genre: document.getElementById('meta-genre').value 
                    }];
                } 
                // CAS 2: PDF (IA)
                else if (detectedType === 'pdf' && file && !editId) {
                    const base64File = await fileToBase64(file);
                    const prompt = `Transforme ce PDF en le√ßon HTML JSON structur√©: { "contenu": { "titre": "...", "html_content": "...", "quiz": [...] } }`;
                    const result = await model.generateContent([prompt, base64File]);
                    let json = result.response.text().replace(/```json|```/g, '').trim();
                    dbObjects = JSON.parse(json).map(l => ({ 
                        niveau, classe, matiere, titre: l.titre, 
                        contenu_html: JSON.stringify(l), 
                        type_contenu: 'pdf_genere', 
                        audio_url: document.getElementById('audioInput').value 
                    }));
                } 
                // CAS 3: MANUEL (JSON/Text)
                else if (detectedType === 'manual') {
                    dbObjects = [{ 
                        niveau, classe, matiere, 
                        titre: document.getElementById('rawTitle').value, 
                        contenu_html: document.getElementById('rawText').value, 
                        type_contenu: 'manuel', 
                        audio_url: document.getElementById('audioInput').value 
                    }];
                }

                // SAUVEGARDE
                if(editId) await supabase.from('lessons').update(dbObjects[0]).eq('id', editId);
                else await supabase.from('lessons').insert(dbObjects);
                
                statusDiv.innerHTML = '‚úÖ Succ√®s ! Rechargement...'; 
                setTimeout(() => window.location.reload(), 1500);

            } catch(e) { statusDiv.innerHTML = 'Erreur: ' + e.message; console.error(e); }
        }

        // --- GESTION CONTENU (EDIT/DELETE) ---
        window.editLesson = async function(id) { 
            const { data } = await supabase.from('lessons').select('*').eq('id', id).single(); 
            switchTab('create'); 
            toggleSource('manual');
            
            document.getElementById('edit-mode-id').value = id; 
            document.getElementById('rawTitle').value = data.titre; 
            document.getElementById('audioInput').value = data.audio_url || "";
            
            // Formatage propre du JSON pour l'√©diteur
            let contentStr = "";
            if (typeof data.contenu_html === 'object' || (typeof data.contenu_html === 'string' && data.contenu_html.trim().startsWith('{'))) {
                try {
                    const jsonObj = typeof data.contenu_html === 'string' ? JSON.parse(data.contenu_html) : data.contenu_html;
                    contentStr = JSON.stringify(jsonObj, null, 2);
                } catch(e) { contentStr = data.contenu_html; }
            } else {
                contentStr = data.contenu_html;
            }
            document.getElementById('rawText').value = contentStr; 
            document.getElementById('form-title').innerText = "Modifier : " + data.titre;
            checkManualInput(); 
        }

        window.deleteLesson = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('lessons').delete().eq('id', id); fetchAllLessons(); } }
        window.fetchAllLessons = async function() { const { data } = await supabase.from('lessons').select('*').order('id', { ascending: false }); allLessons = data || []; renderLessonsList(); }
        window.renderLessonsList = function() { const q = document.getElementById('manage-search').value.toLowerCase(); document.getElementById('lessons-list').innerHTML = allLessons.filter(l => l.titre.toLowerCase().includes(q)).map(l => `<tr class="border-b hover:bg-gray-50"><td class="py-3 px-2 font-bold">${l.titre}</td><td class="text-xs text-gray-500">${l.type_contenu}</td><td class="text-gray-500 text-sm">${l.matiere || '-'}</td><td class="text-right px-2"><button onclick="editLesson(${l.id})" class="text-blue-600 mr-2">‚úèÔ∏è</button><button onclick="deleteLesson(${l.id})" class="text-red-600">üóëÔ∏è</button></td></tr>`).join(''); }
        
        // --- PUBS ---
        window.fetchAds = async function() { const { data } = await supabase.from('ads').select('*').order('created_at', { ascending: false }); allAds = data || []; renderAdsList(); }
        window.renderAdsList = function() { document.getElementById('ads-list').innerHTML = allAds.map(ad => `<div class="flex items-center gap-4 bg-gray-50 p-4 border rounded"><img src="${ad.image_url}" class="w-16 h-10 object-cover"><div class="flex-1 text-sm font-bold text-blue-600 truncate">${ad.link_url}</div><button onclick="deleteAd(${ad.id})" class="text-red-500">üóëÔ∏è</button></div>`).join(''); }
        window.addAd = async function() { const img = document.getElementById('ad-image-url').value; const link = document.getElementById('ad-link-url').value; const loc = document.getElementById('ad-location').value; if(!img) return; await supabase.from('ads').insert([{ image_url: img, link_url: link, emplacement: loc }]); fetchAds(); }
        window.deleteAd = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('ads').delete().eq('id', id); fetchAds(); } }
        
        // --- UTILITAIRES ---
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: file.type } }); reader.onerror = error => reject(error); }); }
        window.loadClasses = function() { const niv = document.getElementById('select-niveau').value; const select = document.getElementById('select-classe'); const classes = [...new Set(existingData.filter(d => d.niveau === niv).map(d => d.classe))]; select.innerHTML = '<option value="">-- Choisir --</option>'; classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`); }
        window.loadMatieres = function() { const niv = document.getElementById('select-niveau').value; const cls = document.getElementById('select-classe').value; const select = document.getElementById('select-matiere'); const matieres = [...new Set(existingData.filter(d => d.niveau === niv && d.classe === cls).map(d => d.matiere))]; select.innerHTML = '<option value="">-- Choisir --</option>'; matieres.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`); }
        window.cancelEditMode = function() { 
            isNewMode = false; document.getElementById('edit-mode-id').value = ''; 
            document.getElementById('rawTitle').value = ''; document.getElementById('rawText').value = ''; 
            toggleSource('file'); // Reset vers fichier par d√©faut
            document.getElementById('form-title').innerText = "2. Contenu du Cours";
            document.getElementById('btn-cancel-edit-mode').classList.add('hidden');
        }
        window.toggleNewForm = function() { isNewMode = !isNewMode; document.getElementById('new-form').classList.toggle('hidden', !isNewMode); document.getElementById('select-niveau').disabled = isNewMode; }
    </script>
</body>
</html>
