<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; gap: 20px; }
        .panel { flex: 1; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        input, textarea, select { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
        button { background: #333; color: white; padding: 10px; cursor: pointer; border: none; }
        .transaction-item { background: #f9f9f9; border-left: 4px solid orange; padding: 10px; margin-bottom: 10px; }
        .transaction-item.valide { border-left-color: green; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>üìö Ajouter / Modifier un Livre</h2>
        <form id="form-livre">
            <label>Titre du livre</label>
            <input type="text" id="titre" required placeholder="Ex: Management 101">

            <label>R√©sum√©</label>
            <textarea id="resume" rows="3" placeholder="Description courte..."></textarea>

            <label>URL de la Cover (Image)</label>
            <input type="url" id="coverUrl" placeholder="https://..." required>

            <label>URL du fichier EPUB</label>
            <input type="url" id="epubUrl" placeholder="https://..." required>

            <label>Donn√©es JSON (Optionnel)</label>
            <textarea id="jsonData" rows="5" placeholder='{"chapitres": 12, "auteur": "Moi"}'></textarea>

            <label>Statut</label>
            <select id="statut">
                <option value="publie">Publi√© (Visible)</option>
                <option value="gele">Gel√© (Cach√©)</option>
            </select>

            <button type="submit">Enregistrer le Livre</button>
        </form>
    </div>

    <div class="panel">
        <h2>üí∞ Paiements en attente</h2>
        <div id="liste-paiements">
            </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. AJOUTER UN LIVRE
        document.getElementById('form-livre').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                titre: document.getElementById('titre').value,
                resume: document.getElementById('resume').value,
                coverUrl: document.getElementById('coverUrl').value,
                epubUrl: document.getElementById('epubUrl').value,
                jsonData: document.getElementById('jsonData').value, // Zone JSON
                statut: document.getElementById('statut').value,     // Publi√© ou Gel√©
                dateCreation: new Date()
            };

            try {
                await addDoc(collection(db, "livres"), data);
                alert("Livre ajout√© avec succ√®s !");
                e.target.reset();
            } catch (err) { alert("Erreur: " + err.message); }
        });

        // 2. GESTION DES PAIEMENTS (TEMPS R√âEL)
        const q = query(collection(db, "transactions"), orderBy("date", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('liste-paiements');
            container.innerHTML = "";

            snapshot.forEach((snap) => {
                const t = snap.data();
                const div = document.createElement('div');
                div.className = `transaction-item ${t.status}`;
                
                let actionBtn = "";
                if(t.status === "en_attente") {
                    actionBtn = `<button style="background:green; margin-top:5px;" onclick="validerPaiement('${snap.id}')">Valider l'acc√®s</button>`;
                } else {
                    actionBtn = "<span>‚úÖ Valid√©</span>";
                }

                div.innerHTML = `
                    <strong>${t.nom}</strong> (${t.numero})<br>
                    Ref: ${t.transactionId}<br>
                    Livre ID: <small>${t.bookId}</small><br>
                    ${actionBtn}
                `;
                container.appendChild(div);
            });
        });

        // Fonction globale pour le bouton HTML
        window.validerPaiement = async (id) => {
            await updateDoc(doc(db, "transactions", id), { status: "valide" });
        };
    </script>
</body>
</html>
