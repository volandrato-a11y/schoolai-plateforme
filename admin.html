<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Studio SchoolAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="layout.js"></script>
    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-source { border-color: #3b82f6 !important; background-color: #eff6ff !important; color: #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 flex flex-col hidden" id="body-content">

    <div id="layout-nav"></div>

    <div class="max-w-6xl mx-auto py-8 px-4 w-full flex-1">
        
        <div class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-2xl font-black text-slate-700">Panneau d'administration</h1>
            <button onclick="logout()" class="text-red-600 font-bold hover:bg-red-50 px-3 py-1 rounded transition"><i class="fas fa-sign-out-alt mr-2"></i>D√©connexion</button>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <button onclick="switchTab('create')" id="tab-create" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white"><i class="fas fa-plus-circle mr-2"></i>Cr√©er / Modifier</button>
            <button onclick="switchTab('manage')" id="tab-manage" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-tasks mr-2"></i>Contenu</button>
            <button onclick="switchTab('sales')" id="tab-sales" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-money-bill-wave mr-2"></i>Ventes</button>
            <button onclick="switchTab('ads')" id="tab-ads" class="flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"><i class="fas fa-ad mr-2"></i>Pubs</button>
        </div>

        <div id="view-create" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-24">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">1. Classement</h2>
                    <input type="hidden" id="edit-mode-id" value="">
                    
                    <div class="space-y-4">
                        <select id="select-niveau" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadClasses()"><option value="">Chargement...</option></select>
                        <select id="select-classe" class="w-full p-3 border rounded-xl bg-gray-50" onchange="loadMatieres()"><option value="">-- D'abord le niveau --</option></select>
                        <select id="select-matiere" class="w-full p-3 border rounded-xl bg-gray-50"><option value="">-- D'abord la classe --</option></select>
                    </div>

                    <div id="library-options" class="hidden mt-6 pt-6 border-t border-gray-100 animate-fade-in bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h3 class="font-bold text-sm text-purple-700 mb-3"><i class="fas fa-book mr-2"></i>Info Biblioth√®que</h3>
                        <div class="space-y-3">
                            <input type="text" id="meta-auteur" placeholder="Auteur" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <input type="text" id="meta-cover" placeholder="URL Image Couverture (https://...)" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white">
                            <select id="meta-genre" class="w-full p-3 border border-purple-200 rounded-lg text-sm bg-white font-bold text-gray-600">
                                <option value="">-- Cat√©gorie --</option>
                                <option value="Roman">üìñ Roman</option><option value="Manuel">üìò Manuel</option><option value="Cours">üéì Cours</option><option value="Jeunesse">üß∏ Jeunesse</option><option value="BD">üí≠ BD/Manga</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="check-publie" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                            <span class="text-slate-700 font-bold text-sm">Publier imm√©diatement ?</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1 ml-8">D√©coch√© = Brouillon (Invisible √©l√®ves)</p>
                    </div>

                    <div class="relative py-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div><div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400 font-bold">Ou cr√©er nouveau</span></div></div>
                    <button onclick="toggleNewForm()" class="w-full py-3 text-sm text-blue-600 font-bold border border-blue-100 bg-blue-50 rounded-xl hover:bg-blue-100 transition"><i class="fas fa-plus-circle mr-2"></i>Nouvelle Mati√®re</button>
                    <div id="new-form" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <select id="new-niveau" class="w-full mb-3 p-2 text-sm border rounded-lg font-bold text-blue-900"><option value="Primaire">Primaire</option><option value="Coll√®ge">Coll√®ge</option><option value="Lyc√©e">Lyc√©e</option><option value="Formation Pro">Formation Pro</option></select>
                        <input id="new-classe" type="text" placeholder="Classe" class="w-full mb-3 p-2 text-sm border rounded-lg">
                        <input id="new-matiere" type="text" placeholder="Mati√®re" class="w-full p-2 text-sm border rounded-lg">
                    </div>
                    <button id="btn-cancel-edit-mode" onclick="cancelEditMode()" class="hidden w-full mt-4 py-3 text-gray-600 font-bold border border-gray-300 bg-gray-100 rounded-xl hover:bg-gray-200 transition">Annuler modif</button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-blue-600 relative">
                    <h2 class="font-bold text-xl mb-6 text-slate-800 border-b pb-2" id="form-title">2. Contenu du Cours</h2>
                    <div class="flex gap-4 mb-6">
                        <button onclick="toggleSource('file')" id="btn-source-file" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition"><i class="fas fa-file-upload mr-2"></i> Fichier</button>
                        <button onclick="toggleSource('manual')" id="btn-source-manual" class="flex-1 py-3 border-2 border-gray-200 bg-white text-gray-500 rounded-xl font-bold hover:bg-gray-50 transition"><i class="fas fa-keyboard mr-2"></i> √âditeur Manuel</button>
                    </div>
                    <div id="zone-upload" class="mb-8 hidden">
                        <div class="border-3 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer relative group bg-slate-50">
                            <input type="file" id="fileInput" accept=".pdf,.epub" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect()">
                            <div class="group-hover:scale-105 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-300 mb-2"></i>
                                <p class="text-sm text-gray-500">Glissez votre PDF ou EPUB ici</p>
                            </div>
                            <p id="file-name" class="text-blue-600 font-bold mt-2 text-sm bg-white inline-block px-4 py-1 rounded-full shadow-sm hidden"></p>
                        </div>
                    </div>
                    <div id="zone-text" class="mb-8 hidden space-y-4">
                        <input type="text" id="rawTitle" placeholder="Titre du cours" class="w-full border p-3 rounded-lg font-bold outline-none focus:ring-2 ring-blue-500" oninput="checkManualInput()">
                        <textarea id="rawText" rows="15" class="w-full border p-3 rounded-lg font-mono text-sm outline-none focus:ring-2 ring-blue-500" placeholder='Collez votre JSON...' oninput="checkManualInput()"></textarea>
                    </div>
                    <div class="mb-8 bg-orange-50 p-6 rounded-xl border border-orange-100">
                        <input type="text" id="audioInput" class="w-full border border-orange-200 p-3 rounded-lg text-sm bg-white" placeholder="Lien Audio/MP3 (Optionnel)...">
                    </div>
                    <button onclick="processData()" id="btn-action" class="w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] cursor-not-allowed" disabled>En attente...</button>
                    <div id="status" class="mt-6 text-center text-sm font-bold"></div>
                </div>
            </div>
        </div>

        <div id="view-manage" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-6 flex gap-4"><input type="text" id="manage-search" placeholder="Rechercher..." class="w-full p-4 pl-12 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white transition" onkeyup="renderLessonsList()"><button onclick="fetchAllLessons()" class="bg-gray-100 text-gray-600 px-6 rounded-xl hover:bg-gray-200 font-bold"><i class="fas fa-sync-alt"></i></button></div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="text-xs font-bold text-gray-500 uppercase border-b border-gray-200"><th class="py-4 pl-4">Statut</th><th class="py-4">Titre</th><th class="py-4">Type</th><th class="py-4">Mati√®re</th><th class="py-4 text-right pr-4">Actions</th></tr></thead><tbody id="lessons-list" class="text-sm"></tbody></table></div>
            </div>
        </div>
        <div id="view-sales" class="hidden">
             <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6"><h2 class="font-bold text-xl text-slate-800">Commandes en attente</h2><button onclick="fetchSales()" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 transition">Actualiser</button></div>
                <div id="sales-list" class="space-y-4"></div>
            </div>
        </div>
        <div id="view-ads" class="hidden">
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <h2 class="font-bold text-lg mb-6 text-slate-700 border-b pb-2">Ajouter Pub</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="ad-id">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label><input type="text" id="ad-image-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lien Clic</label><input type="text" id="ad-link-url" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><select id="ad-location" class="w-full p-3 border rounded-lg text-sm"><option value="home_top">Accueil</option><option value="lesson_sidebar">Sidebar</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fin</label><input type="date" id="ad-end-date" class="w-full p-3 border rounded-lg text-sm"></div>
                        <div class="flex items-center gap-3 py-2"><label class="text-sm font-bold text-gray-600">Actif ?</label><input type="checkbox" id="ad-active" class="h-5 w-5 text-blue-600" checked></div>
                        <div class="flex gap-2"><button onclick="saveAd()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition">Enregistrer</button><button onclick="resetAdForm()" class="px-4 bg-gray-200 text-gray-600 rounded-lg hidden" id="btn-cancel-ad">Annuler</button></div>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-6 text-slate-700">Pubs</h2>
                    <div id="ads-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="layout-footer"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        import { createClient } from "https://esm.run/@supabase/supabase-js";

        // --- CONFIGURATION ---
        const API_KEY_GEMINI = "TOKEN_REMPLACEMENT_ICI"; 
        const SUPABASE_URL = "https://jdxdthxztokjhprwynyf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGR0aHh6dG9ramhwcnd5bnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODAyNzgsImV4cCI6MjA4Mjc1NjI3OH0.zal-p0RKJ-PYGvzal1K9-asbUbyQmqG5OtPTWnoHQmI";
        const ADMIN_EMAIL = "volandrato@gmail.com"; 

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const genAI = new GoogleGenerativeAI(API_KEY_GEMINI);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        let existingData = [], allLessons = [], allAds = [], isNewMode = false, detectedType = null; 

        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            if (session.user.email !== ADMIN_EMAIL) { alert("Refus√©."); window.location.href = 'index.html'; return; }
            document.getElementById('body-content').classList.remove('hidden');
            const { data } = await supabase.from('lessons').select('niveau, classe, matiere');
            if(data) { existingData = data; const niveaux = [...new Set(data.map(d => d.niveau).filter(n => n))]; const select = document.getElementById('select-niveau'); select.innerHTML = '<option value="">-- Choisir --</option>'; niveaux.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`); }
            fetchAllLessons(); fetchAds(); fetchSales();
        };

        window.logout = async function() { await supabase.auth.signOut(); window.location.href = 'login.html'; }
        
        // --- GESTION FICHIER ET UI ---
        window.switchTab = function(t) { ['create','manage','sales','ads'].forEach(id => document.getElementById('view-'+id).classList.toggle('hidden', id !== t)); ['tab-create','tab-manage','tab-sales','tab-ads'].forEach(id => { const btn = document.getElementById(id); if(id === 'tab-'+t) btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-blue-600 text-white"; else btn.className = "flex-1 py-4 font-bold text-lg rounded-xl shadow-sm transition bg-white text-gray-500 hover:bg-gray-50"; }); if(t === 'manage') fetchAllLessons(); if(t === 'sales') fetchSales(); if(t === 'ads') fetchAds(); }
        window.toggleSource = function(mode) { 
            detectedType = mode === 'file' ? null : 'manual';
            document.getElementById('btn-source-file').className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'file' ? "active-source" : "border-gray-200 bg-white text-gray-500");
            document.getElementById('btn-source-manual').className = "flex-1 py-3 border-2 rounded-xl font-bold transition " + (mode === 'manual' ? "active-source" : "border-gray-200 bg-white text-gray-500");
            document.getElementById('zone-upload').classList.toggle('hidden', mode !== 'file');
            document.getElementById('zone-text').classList.toggle('hidden', mode !== 'manual');
            if(mode === 'file') disableButton(); else checkManualInput();
        }

        // --- LES FONCTIONS QUI MANQUAIENT ---
        window.handleFileSelect = function() {
            const input = document.getElementById('fileInput');
            if (input.files && input.files[0]) {
                const f = input.files[0];
                document.getElementById('file-name').innerText = "üìÑ " + f.name;
                document.getElementById('file-name').classList.remove('hidden');
                
                // D√©tection type
                if(f.name.endsWith('.epub')) detectedType = 'epub';
                else if(f.name.endsWith('.pdf')) detectedType = 'pdf';
                
                // Active le bouton
                const btn = document.getElementById('btn-action');
                btn.disabled = false;
                btn.className = "w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] cursor-pointer";
                btn.innerText = "Lancer le traitement IA";
            }
        }

        window.disableButton = function() {
            const btn = document.getElementById('btn-action');
            btn.disabled = true;
            btn.className = "w-full bg-gray-400 text-white font-bold text-lg py-4 rounded-xl shadow-lg cursor-not-allowed";
            btn.innerText = "En attente de fichier...";
            document.getElementById('file-name').classList.add('hidden');
            document.getElementById('fileInput').value = ""; 
        }

        // --- TRAITEMENT IA ---
        window.processData = async function() {
            const statusDiv = document.getElementById('status');
            const file = document.getElementById('fileInput').files[0];
            const editId = document.getElementById('edit-mode-id').value;
            let niveau = isNewMode ? document.getElementById('new-niveau').value : document.getElementById('select-niveau').value;
            let classe = isNewMode ? document.getElementById('new-classe').value : document.getElementById('select-classe').value;
            let matiere = isNewMode ? document.getElementById('new-matiere').value : document.getElementById('select-matiere').value;
            const isPublie = document.getElementById('check-publie').checked;
            
            let titre = detectedType === 'manual' ? document.getElementById('rawTitle').value : (file ? file.name.replace('.epub','').replace('.pdf','') : 'sans-titre');
            let slug = generateSlug(titre);

            if (!detectedType) return alert("S√©lectionnez une source");
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

            try {
                let dbObjects = []; let fileUrl = null;

                if (detectedType === 'epub' && file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; await supabase.storage.from('library').upload(fileName, file); const { data } = supabase.storage.from('library').getPublicUrl(fileName); fileUrl = data.publicUrl;
                    dbObjects = [{ niveau, classe, matiere, titre, slug, type_contenu: 'livre_bibliotheque', file_url: fileUrl, auteur: document.getElementById('meta-auteur').value, genre: document.getElementById('meta-genre').value, image_couverture: document.getElementById('meta-cover').value, est_publie: isPublie }];
                } 
                else if (detectedType === 'pdf' && file && !editId) {
                    const base64File = await fileToBase64(file);
                    
                    const prompt = `
                    Agis comme un expert p√©dagogique. Analyse ce document PDF et g√©n√®re un cours structur√© au format JSON STRICT.
                    ATTENTION : Ta r√©ponse doit √™tre UNIQUEMENT un tableau d'objets JSON valide, sans markdown, sans \`\`\`json, sans texte avant ni apr√®s.
                    
                    Chaque objet du tableau repr√©sente une le√ßon et doit suivre EXACTEMENT cette structure :
                    [{
                      "titre": "Titre de la le√ßon",
                      "contenu": {
                        "definition": "D√©finition courte et claire",
                        "explication": "Le cours complet d√©taill√©. Utilise du Markdown (gras, italique) ici.",
                        "etapes": ["Point cl√© 1", "Point cl√© 2", "Point cl√© 3"],
                        "exemple": "Un exemple concret"
                      },
                      "revisions": {
                        "idees_essentielles": ["R√©sum√© 1", "R√©sum√© 2"],
                        "vocabulaire": [{"terme": "Mot1", "def": "Def1"}, {"terme": "Mot2", "def": "Def2"}]
                      },
                      "exercices": [
                        {"enonce": "Question 1", "solution": "R√©ponse 1"}
                      ],
                      "quiz": [
                        {"question": "Question QCM ?", "options": ["A", "B", "C"], "correct": 0}
                      ]
                    }]`;

                    const result = await model.generateContent([prompt, base64File]);
                    let text = result.response.text();
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const json = JSON.parse(text);

                    dbObjects = json.map(l => ({ 
                        niveau, classe, matiere, titre: l.titre, slug: generateSlug(l.titre), 
                        contenu_html: JSON.stringify(l), type_contenu: 'pdf_genere', 
                        audio_url: document.getElementById('audioInput').value, est_publie: isPublie 
                    }));
                } 
                else if (detectedType === 'manual') {
                    dbObjects = [{ niveau, classe, matiere, titre, slug, contenu_html: document.getElementById('rawText').value, type_contenu: 'manuel', audio_url: document.getElementById('audioInput').value, est_publie: isPublie }];
                }

                if(editId) await supabase.from('lessons').update(dbObjects[0]).eq('id', editId); else await supabase.from('lessons').insert(dbObjects);
                
                statusDiv.innerHTML = '‚úÖ Succ√®s !'; 
                setTimeout(() => window.location.reload(), 1500);
            } catch(e) { statusDiv.innerHTML = 'Erreur: ' + e.message; console.error(e); }
        }

        // --- FONCTIONS UTILITAIRES ---
        window.fetchAllLessons = async function() { const { data } = await supabase.from('lessons').select('*').order('id', { ascending: false }); allLessons = data || []; renderLessonsList(); }
        window.renderLessonsList = function() { const q = document.getElementById('manage-search').value.toLowerCase(); document.getElementById('lessons-list').innerHTML = allLessons.filter(l => l.titre.toLowerCase().includes(q)).map(l => `<tr class="border-b hover:bg-gray-50"><td class="pl-4 py-3"><button onclick="toggleLessonStatus(${l.id}, ${l.est_publie})" class="${l.est_publie ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} px-2 py-1 rounded text-xs font-bold">${l.est_publie ? 'Publi√©' : 'Brouillon'}</button></td><td class="font-bold text-slate-700">${l.titre}</td><td class="text-xs text-gray-500">${l.type_contenu}</td><td class="text-gray-500 text-sm">${l.matiere || '-'}</td><td class="text-right pr-4"><button onclick="editLesson(${l.id})" class="text-blue-600 mr-2">‚úèÔ∏è</button><button onclick="deleteLesson(${l.id})" class="text-red-600">üóëÔ∏è</button></td></tr>`).join(''); }
        window.toggleLessonStatus = async function(id, currentStatus) { await supabase.from('lessons').update({ est_publie: !currentStatus }).eq('id', id); fetchAllLessons(); }
        window.editLesson = async function(id) { const { data } = await supabase.from('lessons').select('*').eq('id', id).single(); switchTab('create'); if(data.type_contenu === 'livre_bibliotheque') { toggleSource('file'); document.getElementById('library-options').classList.remove('hidden'); detectedType = 'epub'; } else { toggleSource('manual'); } document.getElementById('edit-mode-id').value = id; document.getElementById('rawTitle').value = data.titre; document.getElementById('audioInput').value = data.audio_url || ""; document.getElementById('check-publie').checked = data.est_publie; document.getElementById('meta-auteur').value = data.auteur || ""; document.getElementById('meta-genre').value = data.genre || ""; document.getElementById('meta-cover').value = data.image_couverture || ""; let contentStr = data.contenu_html; try { if(typeof data.contenu_html === 'object') contentStr = JSON.stringify(data.contenu_html, null, 2); } catch(e){} document.getElementById('rawText').value = contentStr; document.getElementById('form-title').innerText = "Modifier : " + data.titre; checkManualInput(); }
        window.deleteLesson = async function(id) { if(confirm("Supprimer ?")) { await supabase.from('lessons').delete().eq('id', id); fetchAllLessons(); } }
        window.fetchAds = async function() { const { data } = await supabase.from('ads').select('*').order('created_at', { ascending: false }); allAds = data || []; renderAdsList(); }
        window.renderAdsList = function() { document.getElementById('ads-list').innerHTML = allAds.map(ad => `<div class="flex items-center gap-4 p-4 border rounded ${ad.actif ? 'bg-green-50' : 'opacity-50'}"><span>${ad.link_url}</span><button onclick="toggleAdStatus(${ad.id}, ${ad.actif})">I/O</button><button onclick="deleteAd(${ad.id})">Del</button></div>`).join(''); }
        window.saveAd = async function() { const adObj={image_url:document.getElementById('ad-image-url').value, link_url:document.getElementById('ad-link-url').value, emplacement:document.getElementById('ad-location').value, date_fin:document.getElementById('ad-end-date').value||null, actif:document.getElementById('ad-active').checked}; if(document.getElementById('ad-id').value) await supabase.from('ads').update(adObj).eq('id',document.getElementById('ad-id').value); else await supabase.from('ads').insert([adObj]); resetAdForm(); fetchAds(); }
        window.resetAdForm = function() { document.getElementById('ad-id').value=''; document.getElementById('ad-image-url').value=''; }
        window.toggleAdStatus = async function(id, s) { await supabase.from('ads').update({actif:!s}).eq('id',id); fetchAds(); }
        window.deleteAd = async function(id) { await supabase.from('ads').delete().eq('id',id); fetchAds(); }
        window.fetchSales = async function() { const { data } = await supabase.from('achats').select('*').eq('statut','en_attente'); document.getElementById('sales-list').innerHTML = data ? data.map(a => `<div>${a.montant} Ar - ${a.ref_transaction} <button onclick="validateSale('${a.id}',${a.montant},'${a.user_id}')">OK</button></div>`).join('') : 'Rien'; }
        window.validateSale = async function(id,m,u) { await supabase.from('achats').update({statut:'valide'}).eq('id',id); fetchSales(); }
        window.checkManualInput = function() { document.getElementById('btn-action').disabled = !document.getElementById('rawTitle').value; document.getElementById('btn-action').className = document.getElementById('rawTitle').value ? "w-full bg-green-600 text-white font-bold py-4 rounded-xl" : "w-full bg-gray-400 text-white font-bold py-4 rounded-xl"; }
        function fileToBase64(file) { return new Promise((r,j)=>{const rd=new FileReader();rd.readAsDataURL(file);rd.onload=()=>r({inlineData:{data:rd.result.split(',')[1],mimeType:file.type}});rd.onerror=e=>j(e);}); }
        window.loadClasses=function(){ const niv = document.getElementById('select-niveau').value; const select = document.getElementById('select-classe'); const classes = [...new Set(existingData.filter(d => d.niveau === niv).map(d => d.classe))]; select.innerHTML = '<option value="">-- Choisir --</option>'; classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`); }
        window.loadMatieres=function(){ const niv = document.getElementById('select-niveau').value; const cls = document.getElementById('select-classe').value; const select = document.getElementById('select-matiere'); const matieres = [...new Set(existingData.filter(d => d.niveau === niv && d.classe === cls).map(d => d.matiere))]; select.innerHTML = '<option value="">-- Choisir --</option>'; matieres.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`); }
        window.cancelEditMode=function(){ isNewMode = false; document.getElementById('edit-mode-id').value = ''; document.getElementById('rawTitle').value = ''; document.getElementById('rawText').value = ''; toggleSource('file'); document.getElementById('form-title').innerText = "2. Contenu du Cours"; document.getElementById('btn-cancel-edit-mode').classList.add('hidden'); document.getElementById('check-publie').checked = false; }
        window.toggleNewForm=function(){ isNewMode = !isNewMode; document.getElementById('new-form').classList.toggle('hidden', !isNewMode); document.getElementById('select-niveau').disabled = isNewMode; }
        function generateSlug(text) { return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }
    </script>
</body>
</html>
