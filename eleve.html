<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cours - Acc√®s √âtudiant</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        
        /* Styles des zones */
        #zone-verrouillee { text-align: center; padding: 50px; background: #f4f4f4; border-radius: 8px; }
        #zone-debloquee { display: none; text-align: center; } /* Cach√© par d√©faut */
        
        /* Styles des boutons */
        .btn { padding: 10px 20px; border: none; cursor: pointer; font-size: 16px; border-radius: 5px; margin: 5px; }
        .btn-pay { background: #e74c3c; color: white; }
        .btn-download { background: #27ae60; color: white; text-decoration: none; display: inline-block; }
        .btn-read { background: #3498db; color: white; }
        
        /* Modal */
        #modal-paiement { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 8px; margin: 5px 0 15px 0; box-sizing: border-box; }
        
        /* Lecteur EPUB */
        #viewer-container { width: 100%; height: 600px; border: 1px solid #ddd; margin-top: 20px; display: none; background: #fff; }
    </style>
</head>
<body>

    <h1>Mon Cours de Management</h1>

    <div id="zone-verrouillee">
        <h3>üîí Contenu bloqu√©</h3>
        <p>Pour acc√©der au cours et au livre, veuillez effectuer le paiement.</p>
        <button class="btn btn-pay" onclick="ouvrirModal()">J'ai effectu√© le payement</button>
        <p id="msg-attente" style="color: orange; display:none;">‚è≥ Votre paiement est en cours de v√©rification...</p>
    </div>

    <div id="zone-debloquee">
        <h3>‚úÖ Acc√®s valid√© !</h3>
        <p>Merci pour votre achat. Voici vos acc√®s :</p>
        
        <div style="margin-bottom: 20px;">
            <a id="lien-download" href="#" class="btn btn-download" download>
                üì• T√©l√©charger le fichier (.epub)
            </a>

            <button class="btn btn-read" onclick="lireLivre()">
                üìñ Lire maintenant
            </button>
        </div>

        <div id="viewer-container">
            <div id="viewer"></div>
        </div>
    </div>

    <div id="modal-paiement">
        <div class="modal-content">
            <h3>Confirmation de Paiement</h3>
            <div style="background: #f0f8ff; padding: 10px; margin-bottom: 10px; border-left: 4px solid #3498db;">
                <p style="margin:0;">Faire le payement au :</p>
                <p style="margin:0; font-weight:bold; color:#c0392b;">034 91 207 26 (Ndrato)</p>
            </div>
            <form id="form-paiement">
                <label>Nom du payeur :</label>
                <input type="text" id="nomPayeur" required>
                
                <label>Num√©ro du payeur :</label>
                <input type="text" id="numeroPayeur" required>
                
                <label>N¬∞ Transaction ID :</label>
                <input type="text" id="transacId" required>

                <button type="submit" class="btn btn-pay">Envoyer la preuve</button>
                <button type="button" class="btn" onclick="fermerModal()">Annuler</button>
            </form>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. CONFIGURATION FIREBASE (Remplace par tes cl√©s !)
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "TA_CLE_API",
            authDomain: "TON_PROJET.firebaseapp.com",
            projectId: "TON_PROJET_ID",
            storageBucket: "TON_PROJET.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ID de l'utilisateur (Pour l'exemple on met un ID fixe, mais √ßa devrait venir de l'authentification)
        const userId = "user_demo_123"; 
        // ID du produit achet√©
        const productId = "cours_management_pdf";

        let livreUrl = ""; // On stockera l'URL ici une fois r√©cup√©r√©e

        // ---------------------------------------------------------
        // 2. √âCOUTE EN TEMPS R√âEL (C'est ici que la magie op√®re)
        // ---------------------------------------------------------
        const transactionRef = doc(db, "transactions", userId + "_" + productId);

        // Cette fonction s'ex√©cute AUTOMATIQUEMENT quand tu modifies la base de donn√©es
        onSnapshot(transactionRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                if (data.status === "en_attente") {
                    document.getElementById('msg-attente').style.display = 'block';
                    document.getElementById('msg-attente').innerText = "‚è≥ Preuve envoy√©e. En attente de validation par l'admin...";
                }
                else if (data.status === "valide") {
                    // C'est ici qu'on d√©bloque tout !
                    console.log("Paiement valid√© !");
                    
                    // 1. On stocke l'URL du fichier qui vient de la DB (admin)
                    livreUrl = data.fileUrl; 

                    // 2. On met √† jour l'interface
                    document.getElementById('zone-verrouillee').style.display = 'none';
                    document.getElementById('zone-debloquee').style.display = 'block';

                    // 3. On met √† jour le bouton de t√©l√©chargement
                    const btnDownload = document.getElementById('lien-download');
                    if(livreUrl) {
                        btnDownload.href = livreUrl;
                    } else {
                        btnDownload.style.display = 'none'; // Pas de lien, on cache
                    }
                }
            }
        });

        // ---------------------------------------------------------
        // 3. GESTION DU FORMULAIRE (Envoi preuve)
        // ---------------------------------------------------------
        document.getElementById('form-paiement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nom = document.getElementById('nomPayeur').value;
            const numero = document.getElementById('numeroPayeur').value;
            const ref = document.getElementById('transacId').value;

            try {
                // On √©crit dans la base de donn√©es
                await setDoc(transactionRef, {
                    userId: userId,
                    nom: nom,
                    numero: numero,
                    transactionId: ref,
                    status: "en_attente",
                    date: new Date(),
                    // IMPORTANT: Au d√©but fileUrl est vide, l'admin devra le remplir ou tu le mets par d√©faut si c'est le m√™me pour tout le monde
                    fileUrl: "https://ton-site.com/fichiers/mon-livre.epub" 
                }, { merge: true });

                alert("Merci ! Votre preuve a √©t√© envoy√©e.");
                fermerModal();
            } catch (error) {
                console.error("Erreur : ", error);
                alert("Erreur lors de l'envoi.");
            }
        });

        // ---------------------------------------------------------
        // 4. FONCTIONS UTILITAIRES (Modal + Lecteur)
        // ---------------------------------------------------------
        
        // Exposer les fonctions au HTML global (window)
        window.ouvrirModal = function() {
            document.getElementById('modal-paiement').style.display = 'block';
        }

        window.fermerModal = function() {
            document.getElementById('modal-paiement').style.display = 'none';
        }

        window.lireLivre = function() {
            // CORRECTION DE L'ERREUR ICI
            if (!livreUrl || livreUrl === "") {
                alert("Impossible d'ouvrir le livre. L'URL est vide. Contactez l'admin.");
                return;
            }

            const viewerContainer = document.getElementById('viewer-container');
            const viewerDiv = document.getElementById('viewer');
            
            // Afficher le conteneur
            viewerContainer.style.display = 'block';
            viewerDiv.innerHTML = ""; // Vider si d√©j√† ouvert

            // Initialiser ePub.js
            try {
                var book = ePub(livreUrl);
                var rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    flow: "scrolled-doc" // ou "paginated"
                });
                rendition.display();
            } catch (e) {
                console.error(e);
                alert("Erreur lors du chargement du fichier EPUB.");
            }
        }
    </script>

</body>
</html>
